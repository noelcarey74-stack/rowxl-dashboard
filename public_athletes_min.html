<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Uploads (This Month)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a102f; --panel:#0f2647; --text:#e9f0fb; --muted:#9fb5d1; --brand:#0ea3a7; --danger:#e85c5c;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell; }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px; }
    h1{ margin:0 0 18px; font-size:28px }
    .panel{ background:var(--panel); border:1px solid #ffffff20; border-radius:14px; box-shadow:0 10px 30px #00000055; padding:16px; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 12px; border-bottom:1px solid #ffffff1a; vertical-align:middle; }
    th{ text-align:left; color:var(--muted); font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:.04em; }
    tr:last-child td{ border-bottom:none; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#ffffff14; }
    .pill.red{ background:color-mix(in srgb, var(--danger) 24%, transparent); color:#ffdede; }
    .pill.green{ background:color-mix(in srgb, var(--brand) 24%, transparent); color:#d8fffb; }
    .muted{ color:var(--muted); }
    .bar{ height:10px; border-radius:999px; background:#ffffff18; overflow:hidden }
    .bar > span{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), #22d3ee); width:0% }
    .controls{ display:flex; gap:10px; align-items:center; margin:0 0 14px }
    button{ background:linear-gradient(180deg, #1f95a0, #0ea5a7); color:white; border:none; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer }
    button:disabled{ opacity:.5; cursor:not-allowed }
    select{ background:#0c203e; color:var(--text); border:1px solid #ffffff22; border-radius:10px; padding:8px 10px }
    a { color:#7dd3fc; text-decoration:none }
  </style>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const USE_ATHLETE_NAMES = true;

    async function fetchCounts(){
      const tbody = document.querySelector("#rows");
      const totalEl = document.querySelector("#total");
      const monthEl = document.querySelector("#month");
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

      const { data: counts, error } = await supabase
        .from("upload_counts_current_month")
        .select("*");

      if(error){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Error: ${error.message}</td></tr>`;
        return;
      }

      let nameMap = {};
      if (USE_ATHLETE_NAMES){
        const { data: people } = await supabase
          .from("public_athletes_min")
          .select("user_id, name, email");

        if (people) {
          for (const p of people) {
            nameMap[p.user_id] = { name: p.name, email: p.email };
          }
        }
      }

      const max = Math.max(1, ...counts.map(r => r.uploads));
      const totalUploads = counts.reduce((a,b)=>a + b.uploads, 0);
      totalEl.textContent = totalUploads.toString();

      if (counts.length > 0) {
        const m = new Date(counts[0].month);
        monthEl.textContent = m.toLocaleString(undefined, { month: "long", year: "numeric" });
      } else {
        monthEl.textContent = new Date().toLocaleString(undefined, { month: "long", year: "numeric" });
      }

      counts.sort((a,b)=> b.uploads - a.uploads);

      tbody.innerHTML = "";
      for (const row of counts){
        const info = nameMap[row.user_id] || {};
        const label = info.name || row.user_id;
        const email = info.email || "";
        const flag = row.uploads >= 10 ? `<span class="pill red">≥ 10</span>` : "";
        const pct = Math.round((row.uploads / max) * 100);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="font-weight:600">${label}</div>
            ${email ? `<div class="muted" style="font-size:12px">${email}</div>` : ""}
            <div class="muted" style="font-size:12px">${row.user_id}</div>
          </td>
          <td>${row.uploads}</td>
          <td><div class="bar"><span style="width:${pct}%"></span></div></td>
          <td>${flag}</td>
          <td><a href="#" data-uid="${row.user_id}" class="copy">Copy UID</a></td>
        `;
        tbody.appendChild(tr);
      }

      tbody.addEventListener("click", (e)=>{
        const a = e.target.closest("a.copy");
        if (!a) return;
        e.preventDefault();
        navigator.clipboard.writeText(a.dataset.uid || "");
        a.textContent = "Copied!";
        setTimeout(()=> a.textContent = "Copy UID", 900);
      });
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      document.querySelector("#refresh").addEventListener("click", fetchCounts);
      fetchCounts();
    });
  </script>
</head>

<body>
  <div class="wrap">
    <h1>RowXL — Uploads <span class="muted" id="month"></span></h1>

    <div class="controls">
      <button id="refresh">Refresh</button>

      <!-- ⭐ NEW BUTTON ADDED HERE ⭐ -->
      <button onclick="window.location.href='analyzer.html'">Video Analyzer</button>

      <div class="muted">Total this month: <strong id="total">0</strong></div>
      <div style="flex:1"></div>

      <a href="index.html" class="muted">Coach Inbox</a>
      <span class="muted">·</span>
      <a href="rowxl-programs.html" class="muted">Programs</a>
    </div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>Athlete</th>
            <th>Uploads</th>
            <th>Progress</th>
            <th>Flag</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody id="rows">
          <tr><td colspan="5" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
