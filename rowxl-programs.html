<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Programs (Coach)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb;
      --muted:#9fb5d1; --outline:#1e3a5f; --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }

    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column; min-width:160px }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{
      background:var(--panel2); color:var(--text); border:1px solid var(--outline);
      border-radius:8px; padding:8px 10px; outline:none
    }
    input::placeholder,textarea::placeholder{ color:#7fa1cc }
    button{ cursor:pointer }

    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px; table-layout:fixed }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline); vertical-align:middle }
    th{ background:#0e294c; text-align:left; color:#cfe2ff; font-weight:600 }
    tr:hover td{ background:#0e2543 }

    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; text-decoration:none; color:#e9f0fb; background:transparent }
    .btn.primary{ background:var(--brand); border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.small{ padding:6px 8px; font-size:12px }
    .btn.ghost{ opacity:.9 }

    .tiny{ font-size:12px; color:var(--muted) }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .ellipsis{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .empty{ color:var(--muted); padding:18px }

    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }
    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    #missingFnWarn{ display:none; margin-top:8px; color:#ffc7c7 }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12.5px }
  </style>
</head>
<body>

  <!-- quick links (top-right) -->
  <div style="position:fixed; top:10px; right:10px; font-size:12px; opacity:.9; display:flex; gap:10px; z-index:10">
    <a href="index.html" style="color:#cfe2ff; padding:6px 10px; border:1px solid #1e3a5f; border-radius:999px; background:#113057; text-decoration:none">Coach Inbox</a>
    <a href="rowxl-athlete.html" style="color:#cfe2ff; padding:6px 10px; border:1px solid #1e3a5f; border-radius:999px; background:#113057; text-decoration:none">Athlete view</a>
  </div>

  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1>RowXL — Program Requests & Saved Programs</h1>
      <div class="tiny" style="padding:6px 10px;border:1px solid var(--outline);border-radius:999px;background:var(--panel2)">
        Testing mode (no sign-in)
      </div>
    </div>

    <!-- ===== Program Requests (like Coach Inbox top table) ===== -->
    <div class="panel">
      <div class="controls">
        <div class="field">
          <label for="coachInput">Coach</label>
          <input id="coachInput" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="limitSelect">Limit</label>
          <select id="limitSelect">
            <option>10</option><option selected>20</option><option>40</option><option>80</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:28%">Request (title • preview)</th>
            <th style="width:28%">Athlete (name • email • user id)</th>
            <th style="width:18%">Details</th>
            <th style="width:12%">Created</th>
            <th style="width:14%">Actions</th>
          </tr>
        </thead>
        <tbody id="reqRows">
          <tr><td class="empty" colspan="5">No requests yet.</td></tr>
        </tbody>
      </table>

      <div class="tiny" style="margin-top:8px">
        “Generate program” saves a markdown program (no video). You can open/copy/share it from “Saved Programs” below.
      </div>
      <div id="missingFnWarn" class="tiny"></div>
    </div>

    <!-- ===== Saved Programs (like Saved Reports) ===== -->
    <h2 class="section-title">Saved Programs</h2>
    <div class="panel">
      <div class="controls" style="justify-content:space-between;gap:12px;align-items:flex-end">
        <div class="field">
          <label>&nbsp;</label>
          <button id="loadProgramsBtn" class="btn">Load programs</button>
        </div>
        <div class="field" style="flex:1; min-width:260px">
          <label for="defaultAthlete">Default Athlete UUID (optional)</label>
          <input id="defaultAthlete" placeholder="d64ae833-ed5e-47ff-a43b-5ffa#..." />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <span class="tiny">Click “Share” to send a program to an athlete.</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:30%">Title</th>
            <th style="width:28%">Athlete (name • email • user id)</th>
            <th style="width:14%">Status</th>
            <th style="width:14%">Created</th>
            <th style="width:14%">Actions</th>
          </tr>
        </thead>
        <tbody id="progRows">
          <tr><td class="empty" colspan="5">No programs loaded.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    /* ===== CONFIG (testing mode; no login) ===== */
    const SUPABASE_URL  = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";
    const COACH_SECRET  = "abc1234";   // keep same as Coach Inbox while testing

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const toast = (m, ok=true)=>{ const t=$("#toast"); if(!t) return; t.textContent=m; t.style.display="block"; t.style.borderColor=ok?"#1d5a38":"#8b2a2a"; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display="none",2400); };
    const prettyDate = iso => iso ? new Date(iso).toLocaleString() : "—";
    const coachInput=$("#coachInput");
    coachInput.value = localStorage.getItem("coach_name") || "Noel";
    coachInput.addEventListener("input", ()=> localStorage.setItem("coach_name", coachInput.value.trim()));

    /* ===== Edge wrappers ===== */
    const fn = n => `${SUPABASE_URL}/functions/v1/${n}`;
    async function _fetch(name, init){
      init = init || {};
      init.headers = { ...(init.headers||{}), "Content-Type":"application/json", "Authorization":`Bearer ${SUPABASE_ANON}` };
      if (COACH_SECRET) init.headers["x-coach-secret"] = COACH_SECRET;
      const res = await fetch(fn(name), init);
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        if(res.status===404){
          const w=$("#missingFnWarn"); if(w){ w.style.display="block"; w.textContent=`Missing Edge Function “${name}”. Deploy with: supabase functions deploy ${name}`; }
        }
        throw new Error(`${name} ${res.status}: ${txt||"error"}`);
      }
      const ct = res.headers.get("content-type")||"";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    // inbox: program requests created by athletes (or app) for coaches to action
    const fetchProgramRequests = (limit=20)=> _fetch("programs-inbox", { method:"POST", body: JSON.stringify({ limit }) });
    const generateProgram      = (payload) => _fetch("programs-generate", { method:"POST", body: JSON.stringify(payload) });
    const listPrograms         = (limit=200) => _fetch(`programs-list?limit=${limit}`, { method:"GET" });
    const shareProgram         = (payload) => _fetch("programs-share", { method:"POST", body: JSON.stringify(payload) });
    const deleteProgram        = (payload) => _fetch("programs-delete", { method:"POST", body: JSON.stringify(payload) });

    /* ===== Render: Program Requests (top table) ===== */
    function renderRequests(items){
      const tbody = $("#reqRows"); tbody.innerHTML = "";
      if (!items?.length){ tbody.innerHTML = `<tr><td class="empty" colspan="5">No requests yet.</td></tr>`; return; }

      for(const it of items){
        // expected fields (defensive): title, payload (object), athlete_* , created_at, id/path
        const tr = document.createElement("tr");

        // Request cell — title + compact preview
        const reqCell = document.createElement("td");
        const title = document.createElement("div");
        title.style.fontWeight="600";
        title.className = "ellipsis";
        title.title = it.title || "program request";
        title.textContent = it.title || "program request";
        const prev = document.createElement("div");
        prev.className = "tiny mono ellipsis";
        const p = it.payload || it.request || {};
        const snap = {
          category: p.category, gender: p.gender, boat: p.boat_class || null,
          start: p.start_date, finish: p.finish_date,
          intensity: p.intensity_percent, Mon: p.weekly_schedule?.Mon, Tue: p.weekly_schedule?.Tue, Wed: p.weekly_schedule?.Wed
        };
        prev.textContent = JSON.stringify(snap);
        reqCell.append(title, prev);

        // Athlete identity
        const athleteCell=document.createElement("td");
        const nm=document.createElement("div"); nm.textContent = it.athlete_name || "—";
        const em=document.createElement("div"); em.className="tiny"; em.textContent = it.athlete_email || "—";
        const uid=document.createElement("div"); uid.className="tiny"; uid.style.opacity=0.85; uid.textContent = it.athlete_user_id || it.user_id || "—";
        athleteCell.append(nm, em, uid);

        // Details (nice compact lines)
        const detCell=document.createElement("td");
        const d1=document.createElement("div"); d1.className="tiny";
        const d2=document.createElement("div"); d2.className="tiny";
        const d3=document.createElement("div"); d3.className="tiny ellipsis";
        d1.textContent = `Cat ${p.category||"—"} • Gen ${p.gender||"—"} • Boat ${p.boat_class||"—"}`;
        d2.textContent = `Dates ${p.start_date||"—"} → ${p.finish_date||"—"} • Int ${p.intensity_percent??"—"}%`;
        d3.textContent = `Mon ${p.weekly_schedule?.Mon||"—"} • Tue ${p.weekly_schedule?.Tue||"—"} • Wed ${p.weekly_schedule?.Wed||"—"} …`;
        detCell.append(d1,d2,d3);

        // Created
        const createdCell=document.createElement("td"); createdCell.textContent=prettyDate(it.created_at);

        // Actions
        const actions = document.createElement("td"); actions.className="row-actions";
        const viewBtn=document.createElement("button"); viewBtn.className="btn small ghost"; viewBtn.textContent="Preview";
        viewBtn.onclick=()=>{
          const w = window.open("", "_blank");
          const safe = (x)=> (x==null?"—":String(x));
          w.document.write(`
            <pre style="font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap;padding:16px">
<strong>${safe(it.title)||"Program request"}</strong>

Athlete: ${safe(it.athlete_name)}  |  Email: ${safe(it.athlete_email)}  |  User: ${safe(it.athlete_user_id||it.user_id)}
Created: ${prettyDate(it.created_at)}

${JSON.stringify(p, null, 2)}
            </pre>`);
          w.document.close();
        };

        const genBtn=document.createElement("button"); genBtn.className="btn small primary"; genBtn.textContent="Generate program";
        genBtn.onclick=async()=>{
          const coach=(coachInput.value||"").trim();
          if(!coach) return toast("Enter coach name",false);
          genBtn.disabled=true; genBtn.textContent="Generating…";
          try{
            const body = { ...(p||{}), coach_name: coach, athlete_user_id: (it.athlete_user_id || it.user_id || null) };
            const r = await generateProgram(body);
            if (r?.ok){ toast("Program saved ✔"); genBtn.textContent="Generated"; genBtn.disabled=false; }
            else throw new Error(r?.error||"Failed");
          }catch(e){ toast(e.message||"Error",false); genBtn.textContent="Generate program"; genBtn.disabled=false; }
        };

        // deleting a request (optional; no-op if function not present)
        const delBtn=document.createElement("button"); delBtn.className="btn small danger"; delBtn.textContent="Delete";
        delBtn.onclick=async()=>{
          if(!confirm("Delete this request?")) return;
          delBtn.disabled=true; delBtn.textContent="Deleting…";
          try{
            await _fetch("programs-delete-request", { method:"POST", body: JSON.stringify({ id: it.id, path: it.path||null }) });
            tr.remove(); toast("Request deleted");
          }catch(e){ toast(e.message||"Delete failed",false); delBtn.textContent="Delete"; delBtn.disabled=false; }
        };

        actions.append(viewBtn, genBtn, delBtn);
        tr.append(reqCell, athleteCell, detCell, createdCell, actions);
        tbody.appendChild(tr);
      }
    }

    /* ===== Render: Saved Programs (bottom table; mirrors Saved Reports) ===== */
    function renderPrograms(items){
      const tbody=$("#progRows"); tbody.innerHTML="";
      if(!items?.length){ tbody.innerHTML=`<tr><td class="empty" colspan="5">No programs found.</td></tr>`; return; }

      for(const it of items){
        const tr=document.createElement("tr");

        const titleCell=document.createElement("td");
        const athleteCell=document.createElement("td");
        const statusCell=document.createElement("td");
        const createdCell=document.createElement("td");
        const actionsCell=document.createElement("td"); actionsCell.className="row-actions";

        const displayTitle=(it.title||it.path||it.saved_url||"program").split("/").slice(-1)[0];
        const titleDiv=document.createElement("div"); titleDiv.className="ellipsis"; titleDiv.title=displayTitle; titleDiv.textContent=displayTitle;
        titleCell.appendChild(titleDiv);

        const nm=document.createElement("div"); nm.textContent = it.athlete_name || "—";
        const em=document.createElement("div"); em.className="tiny"; em.textContent = it.athlete_email || "—";
        const uid=document.createElement("div"); uid.className="tiny"; uid.style.opacity=0.85; uid.textContent = it.athlete_user_id || "—";
        athleteCell.append(nm, em, uid);

        statusCell.textContent  = it.status || "done";
        createdCell.textContent = prettyDate(it.created_at);

        const openBtn=document.createElement("a");
        openBtn.className="btn small";
        openBtn.textContent="Open";
        openBtn.target="_blank";
        openBtn.rel="noopener";
        openBtn.href=it.saved_url || it.public_url || "#";

        const copyBtn=document.createElement("button");
        copyBtn.className="btn small";
        copyBtn.textContent="Copy link";
        copyBtn.onclick=async()=>{ try{
          const link=it.saved_url||it.public_url;
          if(!link) throw new Error("No link");
          await navigator.clipboard.writeText(link);
          toast("Link copied ✔");
        }catch(e){ toast(e.message||"Copy failed",false); } };

        const pdfBtn=document.createElement("button");
        pdfBtn.className="btn small";
        pdfBtn.textContent="PDF";
        pdfBtn.onclick=()=>downloadProgramPDF(it);

        const shareBtn=document.createElement("button");
        shareBtn.className="btn small primary";
        shareBtn.textContent="Share";
        shareBtn.onclick=async()=>{
          const def=($("#defaultAthlete").value||"").trim();
          const athleteId=it.athlete_user_id || def;
          if(!athleteId) return toast("Enter athlete UUID (row or default)",false);
          const url=it.saved_url||it.public_url;
          if (!url) return toast("No URL on this program.", false);

          try{
            shareBtn.disabled=true; shareBtn.textContent="Sharing…";
            const r=await shareProgram({
              athlete_user_id: athleteId,
              title: displayTitle,
              url,
              program_id: it.id || null,
              coach_name: (coachInput.value||null)
            });
            if (r?.ok) toast("Shared ✔");
            else throw new Error(r?.error||"Share failed");
          }catch(e){ toast(e.message||"Share failed",false); }
          finally{ shareBtn.disabled=false; shareBtn.textContent="Share"; }
        };

        const delBtn=document.createElement("button");
        delBtn.className="btn small danger";
        delBtn.textContent="Delete";
        delBtn.onclick=async()=>{
          if (!confirm(`Delete program “${displayTitle}”?`)) return;
          try{
            await deleteProgram({ id:it.id, saved_url:it.saved_url, path:it.path });
            tr.remove(); toast("Program deleted");
          }catch(e){ toast(e.message||"Delete failed",false); }
        };

        actionsCell.append(openBtn, copyBtn, pdfBtn, shareBtn, delBtn);
        tr.append(titleCell, athleteCell, statusCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== Minimal PDF (same style as Coach Inbox PDF) ===== */
    async function downloadProgramPDF(row) {
      try {
        const url = row.saved_url || row.public_url;
        if (!url) throw new Error("No saved URL on program.");
        const md = await (await fetch(url)).text();

        const safe = md
          .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replace(/#### (.*)$/gm,"<h4>$1</h4>")
          .replace(/### (.*)$/gm,"<h3>$1</h3>")
          .replace(/## (.*)$/gm,"<h2>$1</h2>")
          .replace(/# (.*)$/gm,"<h1>$1</h1>")
          .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
          .replace(/\n---\n/g,'<hr>')
          .replace(/\n/g,"<br>");

        const coach  = row.coach_name || "—";
        const athleteName  = row.athlete_name || "—";
        const athleteEmail = row.athlete_email || "—";
        const created= row.created_at ? new Date(row.created_at) : null;
        const createdPretty = created ? created.toLocaleString(undefined,{hour12:false}) : "—";
        const title = row.title || row.path || "RowXL — Training Program";

        const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${title}</title>
<style>
  *{box-sizing:border-box} body{margin:0;font:14px/1.45 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial}
  .sheet{padding:28px 32px 48px;color:#0b2a45}
  h1{font-size:22px;margin:22px 0 8px}
  h2{font-size:18px;margin:18px 0 6px}
  h3{font-size:16px;margin:14px 0 4px}
  hr{border:0;border-top:1px solid #e6eef6;margin:18px 0}
</style>
</head>
<body>
  <div class="sheet">
    <div style="text-align:center;margin-bottom:8px">
      <svg viewBox="0 0 520 120" width="220" height="auto" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <text x="18" y="70" font-family="Inter,system-ui,-apple-system,Segoe UI,Roboto" font-size="64" font-weight="700" fill="#0b2a45">RowXL</text>
        <path d="M38 96 C 150 122, 340 68, 458 96" fill="none" stroke="#0b2a45" stroke-width="8" stroke-linecap="round" opacity=".85"/>
      </svg>
      <h1 style="font-size:20px;margin:6px 0 6px;color:#0b2a45">RowXL — Training Program</h1>
    </div>

    <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-size:12.5px;margin-bottom:8px">
      <tr>
        <td style="color:#47627a;width:70px">Athlete</td><td><strong>${athleteName}</strong></td>
        <td style="color:#47627a;width:60px">Email</td><td>${athleteEmail}</td>
      </tr>
      <tr>
        <td style="color:#47627a">Coach</td><td>${coach}</td>
        <td style="color:#47627a">Created</td><td>${createdPretty}</td>
      </tr>
    </table>

    <hr style="border:0;border-top:1px solid #e6eef6;margin:12px 0">
    ${safe}
  </div>
</body>
</html>`;
        const blob = new Blob([html], {type:"text/html"});
        const href = URL.createObjectURL(blob);
        const w = window.open(href, "_blank");
        if (!w) alert("Popup blocked — please allow popups to save PDF.");
      } catch (e) { console.error(e); alert(e.message || String(e)); }
    }

    /* ===== Loaders ===== */
    async function loadRequests(){
      try{
        $("#reqRows").innerHTML=`<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const limit=Number($("#limitSelect").value||20);
        const data=await fetchProgramRequests(limit);
        renderRequests(data?.items||[]);
      }catch(e){
        $("#reqRows").innerHTML=`<tr><td class="empty" colspan="5">Error loading requests.</td></tr>`;
        toast(e.message||"Failed to load requests",false);
      }
    }
    async function loadPrograms(){
      try{
        $("#progRows").innerHTML=`<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const data=await listPrograms(200);
        renderPrograms(data?.items||[]);
      }catch(e){
        $("#progRows").innerHTML=`<tr><td class="empty" colspan="5">Error loading programs.</td></tr>`;
        toast(e.message||"Failed to load programs",false);
      }
    }

    // Wire controls
    $("#refreshBtn").addEventListener("click", loadRequests);
    $("#limitSelect").addEventListener("change", loadRequests);
    $("#loadProgramsBtn").addEventListener("click", loadPrograms);

    // Initial load
    loadRequests();
  </script>
</body>
</html>
