<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Programs (Coach)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb;
      --muted:#9fb5d1; --outline:#1e3a5f; --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }

    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column; min-width:160px }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{
      background:var(--panel2); color:var(--text); border:1px solid var(--outline);
      border-radius:8px; padding:8px 10px; outline:none
    }
    input::placeholder,textarea::placeholder{ color:#7fa1cc }
    button{ cursor:pointer }

    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px; table-layout:fixed }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline); vertical-align:middle }
    th{ background:#0e294c; text-align:left; color:#cfe2ff; font-weight:600 }
    tr:hover td{ background:#0e2543 }

    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; text-decoration:none; color:#e9f0fb; background:transparent }
    .btn.primary{ background:var(--brand); border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.small{ padding:6px 8px; font-size:12px }
    .btn.ghost{ opacity:.9 }

    .tiny{ font-size:12px; color:var(--muted) }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .ellipsis{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .empty{ color:#9fb5d1; padding:18px }

    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }

    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    #missingFnWarn{ display:none; margin-top:8px; color:#ffc7c7 }
    #missingSignWarn{ display:none; margin-top:8px; color:#ffc7c7 }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12.5px }

    .clickable{ cursor:pointer }
    .clickable:after{ content:""; display:inline-block; width:0; height:0; border-left:4px solid #8eb7ff; border-top:4px solid transparent; border-bottom:4px solid transparent; margin-left:6px; opacity:.8 }

    #peek{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999 }
    #peek .card{ width:min(900px,95vw); max-height:90vh; overflow:auto; background:#0f2747; border:1px solid var(--outline); border-radius:12px; padding:14px }
    #peek h3{ margin:0 0 6px; font-size:16px }
    #peek pre{ white-space:pre-wrap; word-break:break-word; margin:8px 0 0; background:#113057; border:1px solid var(--outline); border-radius:8px; padding:10px; font:12.5px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }

    #compose{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999 }
    #compose .card{ width:min(900px,95vw); max-height:90vh; overflow:auto; background:#0f2747; border:1px solid var(--outline); border-radius:12px; padding:14px }
    #compose h3{ margin:0 0 6px; font-size:16px }
    #compose textarea{ width:100%; background:#113057; color:#e9f0fb; border:1px solid var(--outline); border-radius:8px; padding:10px; font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
  </style>
</head>
<body>

  <div style="position:fixed; top:10px; right:10px; font-size:12px; opacity:.9; display:flex; gap:10px; z-index:10">
    <a href="index.html" style="color:#cfe2ff; padding:6px 10px; border:1px solid #1e3a5f; border-radius:999px; background:#113057; text-decoration:none">Coach Inbox</a>
    <a href="rowxl-athlete.html" style="color:#cfe2ff; padding:6px 10px; border:1px solid #1e3a5f; border-radius:999px; background:#113057; text-decoration:none">Athlete view</a>
  </div>

  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1>RowXL — Program Requests & Saved Programs</h1>
      <div class="tiny" style="padding:6px 10px;border:1px solid var(--outline);border-radius:999px;background:var(--panel2)">
        Testing mode (no sign-in)
      </div>
    </div>

    <!-- ===== Program Requests ===== -->
    <div class="panel">
      <div class="controls">
        <div class="field">
          <label for="coachInput">Coach</label>
          <input id="coachInput" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="limitSelect">Limit</label>
          <select id="limitSelect">
            <option>10</option><option selected>20</option><option>40</option><option>80</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:28%">Request (title • preview)</th>
            <th style="width:28%">Athlete (name • email • user id)</th>
            <th style="width:18%">Details</th>
            <th style="width:12%">Created</th>
            <th style="width:14%">Actions</th>
          </tr>
        </thead>
        <tbody id="reqRows">
          <tr><td class="empty" colspan="5">No requests yet.</td></tr>
        </tbody>
      </table>

      <div class="tiny" style="margin-top:8px">
        “Generate program” saves a markdown program (no video). You can open/copy/share it from “Saved Programs” below.
      </div>
      <div id="missingFnWarn" class="tiny"></div>
    </div>

    <!-- ===== Saved Programs ===== -->
    <h2 class="section-title">Saved Programs</h2>
    <div class="panel">
      <div class="controls" style="justify-content:space-between;gap:12px;align-items:flex-end">
        <div class="field">
          <label>&nbsp;</label>
          <button id="loadProgramsBtn" class="btn">Load programs</button>
        </div>
        <div class="field" style="flex:1; min-width:260px">
          <label for="defaultAthlete">Default Athlete UUID (optional)</label>
          <input id="defaultAthlete" placeholder="d64ae833-ed5e-47ff-a43b-5ffa#..." />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <span class="tiny">Click “Share” to send a program to an athlete.</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:30%">Title</th>
            <th style="width:28%">Athlete (name • email • user id)</th>
            <th style="width:14%">Status</th>
            <th style="width:14%">Created</th>
            <th style="width:14%">Actions</th>
          </tr>
        </thead>
        <tbody id="progRows">
          <tr><td class="empty" colspan="5">No programs loaded.</td></tr>
        </tbody>
      </table>
      <div id="missingSignWarn" class="tiny"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Peek modal -->
  <div id="peek" role="dialog" aria-modal="true" aria-labelledby="peekTitle">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 id="peekTitle">Details</h3>
        <button class="btn small" onclick="hidePeek()">Close</button>
      </div>
      <pre id="peekBody"></pre>
    </div>
  </div>

  <!-- Compose modal (manual program entry) -->
  <div id="compose" role="dialog" aria-modal="true" aria-labelledby="composeTitle">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 id="composeTitle">Compose program</h3>
        <button class="btn small" onclick="hideCompose()">Close</button>
      </div>
      <div class="tiny" style="margin:6px 0 8px;color:#9fb5d1">
        Paste or type your program (markdown). Click “Save program” to store it in Saved Programs.
      </div>
      <textarea id="composeText" rows="18"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="hideCompose()">Cancel</button>
        <button class="btn primary" id="composeSaveBtn">Save program</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ===== CONFIG (testing mode; no login) ===== */
    const SUPABASE_URL  = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";
    const COACH_SECRET  = "abc1234";
    const PROGRAM_BUCKET = "programs";          // storage bucket name

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const coachInput=$("#coachInput");
    coachInput.value = localStorage.getItem("coach_name") || "Noel";
    coachInput.addEventListener("input", ()=> localStorage.setItem("coach_name", coachInput.value.trim()));

    const toast = (m, ok=true)=>{ const t=$("#toast"); if(!t) return; t.textContent=m; t.style.display="block"; t.style.borderColor=ok?"#1d5a38":"#8b2a2a"; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display="none",2400); };
    const prettyDate = iso => iso ? new Date(iso).toLocaleString() : "—";

    // Peek modal
    function showPeek(title, body){ $("#peekTitle").textContent = title || "Details"; $("#peekBody").textContent  = body || ""; $("#peek").style.display = "flex"; }
    window.hidePeek = () => $("#peek").style.display = "none";
    function hideCompose(){ $("#compose").style.display = "none"; _composeCtx = null; }
    window.hideCompose = hideCompose;

    // Copy helper
    async function copy(text){ try{ await navigator.clipboard.writeText(text); toast("Copied ✔"); }catch(e){ toast("Copy failed",false); } }

    /* ===== Edge wrappers ===== */
    const fn = n => `${SUPABASE_URL}/functions/v1/${n}`;
    async function _fetch(name, init){
      init = init || {};
      init.headers = { ...(init.headers||{}), "Content-Type":"application/json", "Authorization":`Bearer ${SUPABASE_ANON}` };
      if (COACH_SECRET) init.headers["x-coach-secret"] = COACH_SECRET;
      const res = await fetch(fn(name), init);
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        if(res.status===404){
          const w=$("#missingFnWarn"); if(w){ w.style.display="block"; w.textContent=`Missing Edge Function “${name}”. Deploy with: supabase functions deploy ${name}`; }
        }
        throw new Error(`${name} ${res.status}: ${txt||"error"}`);
      }
      const ct = res.headers.get("content-type")||"";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    // Signer (for private bucket) — separate warning block
    async function signPath(path, expires=300){
      try{
        const res = await _fetch("program-sign", { method:"POST", body: JSON.stringify({ bucket: PROGRAM_BUCKET, path, expires }) });
        if (!res?.url) throw new Error("sign failed");
        return res.url;
      }catch(e){
        const w=$("#missingSignWarn"); if(w && /program-sign 404/.test(String(e))) {
          w.style.display="block";
          w.textContent = `Missing Edge Function “program-sign”. Deploy with: supabase functions deploy program-sign`;
        }
        throw e;
      }
    }

    // REST helper (PostgREST)
    const sbRest = (pathWithQuery, init={}) => fetch(`${SUPABASE_URL}/rest/v1/${pathWithQuery}`, {
      ...init,
      headers: {
        ...(init.headers||{}),
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${SUPABASE_ANON}`,
        Prefer: "return=representation",
        "Content-Type": "application/json"
      }
    });

    // Requests view
    const fetchProgramRequestsREST = async (limit=20) => {
      const q = `program_requests_v?select=id,title,payload,athlete_user_id,athlete_name,athlete_email,created_at,status&order=created_at.desc&limit=${limit}`;
      const res = await sbRest(q);
      if(!res.ok) throw new Error(`program_requests_v ${res.status}`);
      return res.json();
    };

    // Functions (must exist)
    const generateProgram = (payload) => _fetch("program-generate", { method:"POST", body: JSON.stringify(payload) });
    const listPrograms    = (limit=200)      => _fetch(`program-list?limit=${limit}`, { method:"GET" });
    const shareProgram    = (payload)        => _fetch("program-share", { method:"POST", body: JSON.stringify(payload) });
    const deleteProgram   = (payload)        => _fetch("program-delete", { method:"POST", body: JSON.stringify(payload) });

    /* ===== Compose editor ===== */
    let _composeCtx = null;
    function showCompose(ctx){
      _composeCtx = ctx;
      $("#composeTitle").textContent = `Compose — ${ctx.title || "Program"}`;
      $("#composeText").value = [
        `# ${ctx.title || "RowXL — Training Program"}`,
        ``,
        `**Coach:** ${ctx.coach_name || "—"}   |   **Athlete:** ${ctx.athlete_name || "—"}`,
        `---`,
        ``,
        `## Weekly Outline`,
        `- Mon: `,
        `- Tue: `,
        `- Wed: `,
        `- Thu: `,
        `- Fri: `,
        `- Sat: `,
        `- Sun: `,
        ``,
        `## Notes`,
        `- `
      ].join("\n");
      $("#compose").style.display = "flex";
    }

    async function saveComposedProgram(){
      const btn = $("#composeSaveBtn");
      if(!btn || !_composeCtx) return;
      const markdown = $("#composeText").value.trim();
      if(!markdown){ toast("Nothing to save", false); return; }

      btn.disabled = true; btn.textContent = "Saving…";
      try{
        const r = await generateProgram({
          title: _composeCtx.title || "Program",
          coach_name: _composeCtx.coach_name || null,
          athlete_user_id: _composeCtx.athlete_user_id || null,
          markdown
        });
        if (r?.ok) { toast("Program saved ✔"); hideCompose(); }
        else { throw new Error(r?.error || "Save failed"); }
      }catch(e){ toast(e.message || "Save failed", false); }
      finally { btn.disabled = false; btn.textContent = "Save program"; }
    }
    $("#composeSaveBtn")?.addEventListener("click", saveComposedProgram);

    /* ===== Saved Programs ===== */

    // Derive a clean storage path if backend didn't include it (legacy rows with only URL)
    function derivePathFromUrl(url){
      if (!url) return null;
      try{
        // Examples we strip:
        // /storage/v1/object/public/programs/<path>
        // /storage/v1/object/sign/programs/<path>?token=...
        const u = new URL(url);
        const ix = u.pathname.indexOf("/programs/");
        if (ix >= 0) {
          return decodeURIComponent(u.pathname.substring(ix + "/programs/".length));
        }
      }catch{}
      return null;
    }

    function normalizeRow(it){
      const copy = { ...it };
      // title fallback
      copy.title = copy.title || copy.name || null;
      // prefer explicit path, else derive from url-like fields
      copy.path = copy.path
        || derivePathFromUrl(copy.public_url)
        || derivePathFromUrl(copy.saved_url)
        || derivePathFromUrl(copy.url)
        || copy.path
        || null;
      return copy;
    }

    function displayNameFromRow(it){
      const basis = it.title || it.path || it.saved_url || it.public_url || "program";
      return String(basis).split("/").slice(-1)[0];
    }

    async function getProgramURL(it){
      // Public-first (fast)
      if (it.public_url) return it.public_url;
      if (it.saved_url)  return it.saved_url;

      // Private bucket path → signed URL
      if (it.path){
        return await signPath(it.path, 300); // 5 minutes
      }
      // As a last resort, return legacy url so at least something opens
      if (it.url) return it.url;

      throw new Error("No path/url on this row.");
    }

    function renderPrograms(items){
      const tbody=$("#progRows"); tbody.innerHTML="";
      if(!items?.length){ tbody.innerHTML=`<tr><td class="empty" colspan="5">No programs found.</td></tr>`; return; }

      for(const itRaw of items){
        const it = normalizeRow(itRaw);

        const tr=document.createElement("tr");

        const titleCell=document.createElement("td");
        const athleteCell=document.createElement("td");
        const statusCell=document.createElement("td");
        const createdCell=document.createElement("td");
        const actionsCell=document.createElement("td"); actionsCell.className="row-actions";

        const displayTitle=displayNameFromRow(it);
        const titleDiv=document.createElement("div"); titleDiv.className="ellipsis"; titleDiv.title=displayTitle; titleDiv.textContent=displayTitle;
        titleCell.appendChild(titleDiv);

        const nm=document.createElement("div"); nm.textContent = it.athlete_name || "—";
        const em=document.createElement("div"); em.className="tiny ellipsis"; em.textContent = it.athlete_email || "—"; em.title = it.athlete_email || "";
        const uid=document.createElement("div"); uid.className="tiny ellipsis"; uid.style.opacity=0.85; uid.textContent = it.athlete_user_id || "—"; uid.title = it.athlete_user_id || "";
        athleteCell.append(nm, em, uid);

        statusCell.textContent  = it.status || "done";
        createdCell.textContent = prettyDate(it.created_at);

        const openBtn=document.createElement("a");
        openBtn.className="btn small";
        openBtn.textContent="Open";
        openBtn.target="_blank"; openBtn.rel="noopener";

        // set href lazily when clicked (so signed URL is fresh)
        openBtn.addEventListener("click", async (ev)=>{
          try{
            openBtn.textContent="Open…";
            const url = await getProgramURL(it);
            openBtn.href = url;
            // allow default navigation after first click
          }catch(e){
            ev.preventDefault();
            toast(e.message||"Open failed", false);
            openBtn.textContent="Open";
          }
        }, { once:true });

        const copyBtn=document.createElement("button");
        copyBtn.className="btn small";
        copyBtn.textContent="Copy link";
        copyBtn.onclick=async()=>{
          try{
            copyBtn.textContent="Copying…";
            const url=await getProgramURL(it);
            await navigator.clipboard.writeText(url);
            toast("Link copied ✔");
          }catch(e){ toast(e.message||"Copy failed",false); }
          finally{ copyBtn.textContent="Copy link"; }
        };

        const pdfBtn=document.createElement("button");
        pdfBtn.className="btn small";
        pdfBtn.textContent="PDF";
        pdfBtn.onclick=()=>downloadProgramPDF(it);

        const shareBtn=document.createElement("button");
        shareBtn.className="btn small primary";
        shareBtn.textContent="Share";
        shareBtn.onclick=async()=>{
          const def=($("#defaultAthlete").value||"").trim();
          const athleteId=it.athlete_user_id || def;
          if(!athleteId) return toast("Enter athlete UUID (row or default)",false);

          try{
            shareBtn.disabled=true; shareBtn.textContent="Sharing…";
            const signedUrl = await getProgramURL(it);   // satisfies NOT NULL url on table
            const payload = {
              athlete_user_id: athleteId,
              title: displayTitle,
              url: signedUrl,                 // keep for NOT NULL constraint / coach web use
              program_id: it.id || null,
              coach_name: (coachInput.value||null),
              path: it.path || null           // app will prefer this for private download
            };
            const r=await shareProgram(payload);
            if (r?.ok) toast("Shared ✔");
            else throw new Error(r?.error||"Share failed");
          }catch(e){ toast(e.message||"Share failed",false); }
          finally{ shareBtn.disabled=false; shareBtn.textContent="Share"; }
        };

        const delBtn=document.createElement("button");
        delBtn.className="btn small danger";
        delBtn.textContent="Delete";
        delBtn.onclick=async()=>{
          if (!confirm(`Delete program “${displayTitle}”?`)) return;
          try{
            await deleteProgram({ id:it.id, saved_url:it.saved_url, path:it.path });
            tr.remove(); toast("Program deleted");
          }catch(e){ toast(e.message||"Delete failed",false); }
        };

        actionsCell.append(openBtn, copyBtn, pdfBtn, shareBtn, delBtn);
        tr.append(titleCell, athleteCell, statusCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== Minimal PDF builder (client-side) ===== */
    async function downloadProgramPDF(row) {
      try {
        const url = await getProgramURL(row);
        const md = await (await fetch(url)).text();

        const safe = md
          .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replace(/#### (.*)$/gm,"<h4>$1</h4>")
          .replace(/### (.*)$/gm,"<h3>$1</h3>")
          .replace(/## (.*)$/gm,"<h2>$1</h2>")
          .replace(/# (.*)$/gm,"<h1>$1</h1>")
          .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
          .replace(/\n---\n/g,'<hr>')
          .replace(/\n/g,"<br>");

        const coach  = row.coach_name || "—";
        const athleteName  = row.athlete_name || "—";
        const athleteEmail = row.athlete_email || "—";
        const created= row.created_at ? new Date(row.created_at) : null;
        const createdPretty = created ? created.toLocaleString(undefined,{hour12:false}) : "—";
        const title = displayNameFromRow(row);

        const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${title}</title>
<style>
  *{box-sizing:border-box} body{margin:0;font:14px/1.45 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial}
  .sheet{padding:28px 32px 48px;color:#0b2a45}
  h1{font-size:22px;margin:22px 0 8px}
  h2{font-size:18px;margin:18px 0 6px}
  h3{font-size:16px;margin:14px 0 4px}
  hr{border:0;border-top:1px solid #e6eef6;margin:18px 0}
</style>
</head>
<body>
  <div class="sheet">
    <div style="text-align:center;margin-bottom:8px">
      <svg viewBox="0 0 520 120" width="220" height="auto" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <text x="18" y="70" font-family="Inter,system-ui,-apple-system,Segoe UI,Roboto" font-size="64" font-weight="700" fill="#0b2a45">RowXL</text>
        <path d="M38 96 C 150 122, 340 68, 458 96" fill="none" stroke="#0b2a45" stroke-width="8" stroke-linecap="round" opacity=".85"/>
      </svg>
      <h1 style="font-size:20px;margin:6px 0 6px;color:#0b2a45">RowXL — Training Program</h1>
    </div>

    <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-size:12.5px;margin-bottom:8px">
      <tr>
        <td style="color:#47627a;width:70px">Athlete</td><td><strong>${athleteName}</strong></td>
        <td style="color:#47627a;width:60px">Email</td><td>${athleteEmail}</td>
      </tr>
      <tr>
        <td style="color:#47627a">Coach</td><td>${coach}</td>
        <td style="color:#47627a">Created</td><td>${createdPretty}</td>
      </tr>
    </table>

    <hr style="border:0;border-top:1px solid #e6eef6;margin:12px 0">
    ${safe}
  </div>
</body>
</html>`;
        const blob = new Blob([html], {type:"text/html"});
        const href = URL.createObjectURL(blob);
        const w = window.open(href, "_blank");
        if (!w) alert("Popup blocked — please allow popups to save PDF.");
      } catch (e) { console.error(e); alert(e.message || String(e)); }
    }

    /* ===== Loaders ===== */
    async function loadRequests(){
      try{
        $("#reqRows").innerHTML=`<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const limit=Number($("#limitSelect").value||20);
        const items = await fetchProgramRequestsREST(limit);
        renderRequests(items||[]);
      }catch(e){
        $("#reqRows").innerHTML=`<tr><td class="empty" colspan="5">Error loading requests.</td></tr>`;
        toast(e.message||"Failed to load requests",false);
      }
    }

    async function loadPrograms(){
      try{
        $("#progRows").innerHTML=`<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        let data = await listPrograms(200);
        let items = data?.items || [];

        // Fallback to REST if function missing/empty
        if (!items.length) {
          const res = await sbRest('program_files?select=*&order=created_at.desc&limit=200');
          if (res.ok) items = await res.json();
        }

        renderPrograms(items||[]);
      }catch(e){
        $("#progRows").innerHTML=`<tr><td class="empty" colspan="5">Error loading programs.</td></tr>`;
        toast(e.message||"Failed to load programs",false);
      }
    }

    // Wire controls
    $("#refreshBtn").addEventListener("click", loadRequests);
    $("#limitSelect").addEventListener("change", loadRequests);
    $("#loadProgramsBtn").addEventListener("click", loadPrograms);

    // Initial load
    loadRequests();
  </script>
</body>
</html>
