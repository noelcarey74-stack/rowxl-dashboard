<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Coach Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb; --muted:#9fb5d1; --outline:#1e3a5f; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }
    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{ background:var(--panel2); color:var(--text); border:1px solid var(--outline); border-radius:8px; padding:8px 10px; outline:none }
    input::placeholder,textarea::placeholder{ color:#7fa1cc }
    button{ cursor:pointer }
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline) }
    th{ background:#0e294c; text-align:left; color:#cfe2ff; font-weight:600 }
    tr:hover td{ background:#0e2543 }
    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .note{ width:200px; height:46px; resize:vertical }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }
    .empty{ color:var(--muted); padding:18px }
    a.link-btn, .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; text-decoration:none; color:#e9f0fb; background:transparent }
    .btn.primary{ background:#0e3a73; border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.ghost{ opacity:.85 }
    .btn.small{ padding:6px 8px; font-size:12px }
    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    .grid{ display:grid; grid-template-columns:1fr auto auto auto auto; gap:10px; align-items:center }
    @media (max-width: 900px){
      .note{ width:160px }
      .grid{ grid-template-columns:1fr auto auto auto }
      .hide-sm{ display:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RowXL — Coach Inbox</h1>

    <!-- ===== Inbox (videos to review) ===== -->
    <div class="panel">
      <div class="controls">
        <div class="field">
          <label for="boatFilter">Boat filter</label>
          <select id="boatFilter">
            <option value="all">All boats</option>
          </select>
        </div>
        <div class="field">
          <label for="coachInput">Coach</label>
          <input id="coachInput" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="limitSelect">Limit</label>
          <select id="limitSelect">
            <option>10</option><option selected>20</option><option>40</option><option>80</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <label style="display:flex;gap:8px;align-items:center;">
            <input id="autoDeleteChk" type="checkbox" />
            <span class="hide-sm">Delete clip after AI send</span>
          </label>
        </div>
      </div>

      <table id="jobs">
        <thead>
          <tr>
            <th style="width:42%">Video</th>
            <th style="width:10%">Boat</th>
            <th style="width:10%">Status</th>
            <th style="width:18%">Created</th>
            <th style="width:20%">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td class="empty" colspan="5">No videos yet.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ===== Saved Reports ===== -->
    <h2 class="section-title">Saved Reports</h2>
    <div class="panel">
      <div class="controls" style="justify-content:space-between;gap:12px;align-items:flex-end">
        <div class="field">
          <label>&nbsp;</label>
          <button id="loadReportsBtn" class="btn">Load reports</button>
        </div>

        <!-- Default athlete UUID (used when a report row doesn't have one) -->
        <div class="field" style="flex:1; min-width:260px">
          <label for="defaultAthlete">Default Athlete UUID (optional)</label>
          <input id="defaultAthlete" placeholder="d64ae833-ed5e-47ff-a43b-5ffa#..." />
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <span id="reportsHint" style="color:#9fb5d1;font-size:12px">Click “Share” to create a share row for an athlete.</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:32%">Title</th>
            <th style="width:18%">Athlete</th>
            <th style="width:10%">Status</th>
            <th style="width:18%">Created</th>
            <th style="width:22%">Actions</th>
          </tr>
        </thead>
        <tbody id="reportsRows">
          <tr><td class="empty" colspan="5">No reports loaded.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    /* ===== CONFIG (EDIT THESE IF NEEDED) ===== */
    const SUPABASE_URL  = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";
    const COACH_SECRET  = "abc1234";   // must match your Edge Function check
    const DEFAULT_COACH = "Noel";
    const BOATS = ["8+", "4+", "4x", "4x-", "4-", "2x", "2-", "1x"];

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const toast = (msg, ok=true) => {
      const t = $("#toast"); if (!t) return;
      t.textContent = msg; t.style.display = "block";
      t.style.borderColor = ok ? "#1d5a38" : "#8b2a2a";
      setTimeout(()=> t.style.display = "none", 2400);
    };
    const prettyDate = iso => iso ? new Date(iso).toLocaleString() : "—";

    /* Persist report links locally (optional) */
    const REPORT_STORE_KEY = "rowxl_report_links";
    function saveReportLinkFor(key, url) {
      const all = JSON.parse(localStorage.getItem(REPORT_STORE_KEY) || "{}");
      all[key] = { url, ts: Date.now() };
      localStorage.setItem(REPORT_STORE_KEY, JSON.stringify(all));
    }
    function getReportLinkFor(key) {
      const all = JSON.parse(localStorage.getItem(REPORT_STORE_KEY) || "{}");
      return all[key]?.url || null;
    }

    /* Seed filters + coach name */
    const boatFilter = $("#boatFilter");
    ["all", ...BOATS].forEach((b, i) => {
      if (i===0) return;
      const o = document.createElement("option");
      o.value = b; o.textContent = b;
      boatFilter.appendChild(o);
    });
    const coachInput = $("#coachInput");
    coachInput.value = localStorage.getItem("coach_name") || DEFAULT_COACH;
    coachInput.addEventListener("input", ()=> localStorage.setItem("coach_name", coachInput.value.trim()));

    /* ===== Edge functions ===== */

    // Inbox: videos to review
    async function fetchInbox(limit=20){
      const url = `${SUPABASE_URL}/functions/v1/coach-inbox`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-coach-secret": COACH_SECRET
        },
        body: JSON.stringify({ limit })
      });
      if (!res.ok) throw new Error(`Inbox error ${res.status}: ${await res.text()}`);
      return await res.json();
    }

    // Queue an AI job for a video
    async function sendVideoJob({ file_path, coach_notes, boat, coach_name, delete_on_finish=false }){
      const res = await fetch(`${SUPABASE_URL}/functions/v1/coach-send-job`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-coach-secret": COACH_SECRET
        },
        body: JSON.stringify({ file_path, coach_notes, coach_name, boat, delete_on_finish })
      });
      if (!res.ok) {
        // Helpful message if DB is missing coach_name column
        const txt = await res.text().catch(()=> "");
        if (txt.includes("coach_name") && txt.includes("schema cache")) {
          throw new Error("Server is missing column coach_name in video_jobs. Run:\nALTER TABLE video_jobs ADD COLUMN coach_name text;");
        }
        throw new Error(`Send job error ${res.status}: ${txt || "Unknown error"}`);
      }
      return await res.json();
    }

    // Delete a video from storage
    async function deleteVideo(path){
      const res = await fetch(`${SUPABASE_URL}/functions/v1/coach-delete-video`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-coach-secret": COACH_SECRET
        },
        body: JSON.stringify({ path })
      });
      if (!res.ok) throw new Error(`Delete error ${res.status}: ${await res.text()}`);
      return await res.json();
    }

    // List saved reports
    async function listReports(limit=100){
      const res = await fetch(`${SUPABASE_URL}/functions/v1/coach-list-reports?limit=${limit}`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-coach-secret": COACH_SECRET
        }
      });
      if (!res.ok) throw new Error(`List reports error ${res.status}: ${await res.text()}`);
      return await res.json();
    }

    // Share a report with an athlete (writes to report_shares)
    async function shareReport({ athlete_user_id, title, url, report_id }){
      const res = await fetch(`${SUPABASE_URL}/functions/v1/coach-share-report`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-coach-secret": COACH_SECRET
        },
        body: JSON.stringify({ athlete_user_id, title, url, report_id })
      });
      if (!res.ok) throw new Error(`Share error ${res.status}: ${await res.text()}`);
      return await res.json();  // expect { ok:true, id, ... }
    }

    /* ===== Render: inbox ===== */
    function renderRows(items){
      const tbody = $("#rows");
      tbody.innerHTML = "";
      if (!items?.length){
        tbody.innerHTML = `<tr><td class="empty" colspan="5">No videos yet.</td></tr>`;
        return;
      }

      const selectedBoat = boatFilter.value;

      for (const it of items){
        const defaultBoat = "";
        if (selectedBoat !== "all" && selectedBoat !== defaultBoat) continue;

        const tr = document.createElement("tr");

        const videoCell = document.createElement("td");
        const name = (it.path || it.video_path || "").split("/").pop() || it.id || "video";
        const openUrl = it.signed_url || it.signedUrl || it.url || it.video_path;
        videoCell.innerHTML = `
          <div class="grid">
            <div style="display:flex;gap:10px;align-items:center;">
              <div style="min-width:10px;height:10px;border-radius:99px;background:#3d7cff"></div>
              <div>
                <div style="font-weight:600">${name}</div>
                <div style="color:#9fb5d1;font-size:12px">${it.user_id ? `User: ${it.user_id}` : ""}</div>
              </div>
            </div>
          </div>`;

        const boatCell = document.createElement("td");
        const boatSel = document.createElement("select");
        boatSel.innerHTML = `<option value="">—</option>` + BOATS.map(b=>`<option>${b}</option>`).join("");
        boatSel.value = it.boat || defaultBoat;
        boatCell.appendChild(boatSel);

        const statusCell = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = it.job_status || it.status || "new";
        statusCell.appendChild(pill);

        const createdCell = document.createElement("td");
        createdCell.textContent = prettyDate(it.created_at || it.uploaded_at);

        const actionsCell = document.createElement("td");
        actionsCell.className = "row-actions";

        const previewBtn = document.createElement("button");
        previewBtn.className = "btn ghost";
        previewBtn.textContent = "Preview";
        previewBtn.onclick = () => {
          if (!openUrl){ toast("No signed URL available.", false); return; }
          window.open(openUrl, "_blank");
        };

        const note = document.createElement("textarea");
        note.className = "note";
        note.placeholder = "Coach notes (what you saw; what to work on)…";

        const sendBtn = document.createElement("button");
        sendBtn.className = "btn primary";
        sendBtn.textContent = "Send to AI";

        const delBtn = document.createElement("button");
        delBtn.className = "btn danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (!confirm(`Delete clip "${name}" from storage?`)) return;
          delBtn.disabled = true; delBtn.textContent = "Deleting…";
          try { await deleteVideo(it.path); tr.remove(); toast("Video deleted"); }
          catch (e){ toast(e.message || "Delete failed", false); }
          finally { delBtn.disabled = false; delBtn.textContent = "Delete"; }
        };

        sendBtn.onclick = async () => {
          const coach = (coachInput.value || "").trim();
          const boat = boatSel.value || "";
          const text = (note.value || "").trim();
          const deleteAfter = $("#autoDeleteChk").checked;
          if (!coach) return toast("Enter coach name first.", false);
          if (!text)  return toast("Add a quick note for AI.", false);

          sendBtn.disabled = true; sendBtn.textContent = "Sending…";
          try{
            const r = await sendVideoJob({ file_path: it.path, coach_notes: text, boat, coach_name: coach, delete_on_finish: deleteAfter });
            if (r?.ok){ pill.classList.add("done"); pill.textContent = "sent"; toast("Queued for AI ✔"); }
            else throw new Error(r?.error || r?.message || "Failed");
          }catch(e){ toast(e.message || "Error", false); }
          finally{ sendBtn.disabled = false; sendBtn.textContent = "Send to AI"; }
        };

        actionsCell.append(previewBtn, note, sendBtn, delBtn);
        tr.append(videoCell, boatCell, statusCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== Render: saved reports with Share button ===== */
    function renderReports(items){
      const tbody = $("#reportsRows");
      tbody.innerHTML = "";

      if (!items?.length){
        tbody.innerHTML = `<tr><td class="empty" colspan="5">No reports found.</td></tr>`;
        return;
      }

      for (const it of items){
        const tr = document.createElement("tr");

        const titleCell   = document.createElement("td");
        const athleteCell = document.createElement("td");
        const statusCell  = document.createElement("td");
        const createdCell = document.createElement("td");
        const actionsCell = document.createElement("td"); actionsCell.className = "row-actions";

        const displayTitle = (it.title || it.saved_url || it.path || "").split("/").slice(-1)[0] || "report";
        titleCell.textContent = displayTitle;
        athleteCell.textContent = it.athlete_user_id || "—";
        statusCell.textContent  = it.status || "done";
        createdCell.textContent = prettyDate(it.created_at);

        const openBtn = document.createElement("a");
        openBtn.className = "btn small";
        openBtn.textContent = "Open";
        openBtn.target = "_blank";
        openBtn.rel = "noopener";
        openBtn.href = it.saved_url || it.public_url || "#";

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn small";
        copyBtn.textContent = "Copy link";
        copyBtn.onclick = async () => {
          try{
            const link = it.saved_url || it.public_url;
            if (!link) throw new Error("No public link on this report.");
            await navigator.clipboard.writeText(link);
            toast("Link copied ✔");
          }catch(e){ toast(e.message || "Copy failed", false); }
        };

        const pdfBtn = document.createElement("button");
        pdfBtn.className = "btn small";
        pdfBtn.textContent = "PDF";
        pdfBtn.onclick = () => downloadPDF(it);

        // Share button → writes to report_shares via Edge Function
        const shareBtn = document.createElement("button");
        shareBtn.className = "btn small primary";
        shareBtn.textContent = "Share";
        shareBtn.onclick = async () => {
          const athleteId = it.athlete_user_id || ($("#defaultAthlete").value || "").trim();
          if (!athleteId) return toast("Set athlete UUID (row or default) to share.", false);

          const url = it.saved_url || it.public_url;
          if (!url) return toast("No URL on this report.", false);

          shareBtn.disabled = true; shareBtn.textContent = "Sharing…";
          try{
            const r = await shareReport({
              athlete_user_id: athleteId,
              title: displayTitle,
              url,
              report_id: it.id || null
            });
            if (r?.ok) toast("Shared with athlete ✔");
            else throw new Error(r?.error || "Share failed");
          }catch(e){ toast(e.message || "Share failed", false); }
          finally{ shareBtn.disabled = false; shareBtn.textContent = "Share"; }
        };

        const delBtn = document.createElement("button");
        delBtn.className = "btn small danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (!confirm(`Delete report "${displayTitle}"?`)) return;
          try{
            const res = await fetch(`${SUPABASE_URL}/functions/v1/coach-delete-report`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${SUPABASE_ANON}`,
                "x-coach-secret": COACH_SECRET
              },
              body: JSON.stringify({ id: it.id, saved_url: it.saved_url, path: it.path })
            });
            if (!res.ok) throw new Error(await res.text());
            tr.remove(); toast("Report deleted");
          }catch(e){ toast(e.message || "Delete failed", false); }
        };

        actionsCell.append(openBtn, copyBtn, pdfBtn, shareBtn, delBtn);
        tr.append(titleCell, athleteCell, statusCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== PDF maker (client-side) ===== */
    async function downloadPDF(report){
      try{
        const url = report.saved_url || report.public_url;
        if (!url) throw new Error("No saved URL on report.");
        const md = await (await fetch(url)).text();

        const safe = md
          .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
          .replace(/^### (.*)$/gm, "<h3>$1</h3>")
          .replace(/^## (.*)$/gm, "<h2>$1</h2>")
          .replace(/^# (.*)$/gm, "<h1>$1</h1>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/\n/g, "<br/>");

        const created = prettyDate(report.created_at);
        const logo = "https://juqfwsodydmmzcavkqtd.supabase.co/storage/v1/object/public/reports/branding/logo.png";

        const html = `
<!doctype html>
<html><head><meta charset="utf-8">
<title>${report.title || "RowXL Report"}</title>
<style>
  body{ font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; margin:0; background:#f7fbff; }
  .header{ background:#0a1a2f; color:#fff; padding:24px 18px; text-align:center }
  .header img{ height:40px; display:block; margin:0 auto 8px }
  .wrap{ max-width:800px; margin:24px auto; background:#fff; border:1px solid #e3edf7; border-radius:14px; box-shadow:0 6px 20px rgba(10,26,47,0.06) }
  .inner{ padding:24px }
  h1,h2,h3{ color:#0a1a2f; margin:0 0 8px }
  .meta{ color:#335; font-size:14px; margin-bottom:12px }
  hr{ border:0; border-top:1px solid #e5effa; margin:18px 0 }
  @media print{ .wrap{ box-shadow:none; border:0 } body{ background:#fff } }
</style></head>
<body>
  <div class="header">
    <img src="${logo}" alt="RowXL">
    <div>Performance Coaching Report</div>
  </div>
  <div class="wrap"><div class="inner">
    <h2>${report.title ? report.title.split("/").slice(-1)[0] : "RowXL Report"}</h2>
    <div class="meta">Coach: ${coachInput.value || "—"} • Created: ${created}</div>
    <hr/>
    <div>${safe}</div>
  </div></div>
  <script>window.onload = () => setTimeout(()=>window.print(), 300);<\/script>
</body></html>`;
        const win = window.open("", "_blank");
        win.document.open(); win.document.write(html); win.document.close();
      }catch(e){ toast(e.message || "PDF failed", false); }
    }

    /* ===== Loaders / wiring ===== */
    async function loadInbox(){
      try{
        $("#rows").innerHTML = `<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const limit = Number($("#limitSelect").value || 20);
        const data  = await fetchInbox(limit);
        renderRows(data?.items || []);
      }catch(e){
        $("#rows").innerHTML = `<tr><td class="empty" colspan="5">Error loading inbox.</td></tr>`;
        toast("Failed to load inbox", false);
      }
    }

    async function loadReports(){
      try{
        $("#reportsRows").innerHTML = `<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const data = await listReports(200);
        renderReports(data?.items || []);
      }catch(e){
        $("#reportsRows").innerHTML = `<tr><td class="empty" colspan="5">Error loading reports.</td></tr>`;
        toast("Failed to load reports", false);
      }
    }

    $("#refreshBtn").addEventListener("click", loadInbox);
    $("#limitSelect").addEventListener("change", loadInbox);
    $("#boatFilter").addEventListener("change", loadInbox);
    $("#loadReportsBtn").addEventListener("click", loadReports);

    // First load
    loadInbox();
  </script>
</body>
</html>
