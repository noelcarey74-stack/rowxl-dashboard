<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Coach Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb;
      --muted:#9fb5d1; --outline:#1e3a5f; --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }
    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{
      background:var(--panel2); color:var(--text); border:1px solid var(--outline);
      border-radius:8px; padding:8px 10px; outline:none
    }
    input::placeholder,textarea::placeholder{ color:#7fa1cc }
    button{ cursor:pointer }

    /* Table + tidy columns */
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px; table-layout:fixed }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline); vertical-align:middle }
    th{ background:#0e294c; text-align:left; color:#cfe2ff; font-weight:600 }
    tr:hover td{ background:#0e2543 }

    /* Helpers */
    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .note{ width:200px; height:46px; resize:vertical }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }
    .empty{ color:var(--muted); padding:18px }
    .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; text-decoration:none; color:#e9f0fb; background:transparent }
    .btn.primary{ background:var(--brand); border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.ghost{ opacity:.85 }
    .btn.small{ padding:6px 8px; font-size:12px }
    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    .tiny{ font-size:12px; color:#9fb5d1 }

    /* Nicer truncation for long paths/URLs */
    .cell-title{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    @media (max-width: 980px){
      .note{ width:160px }
    }
  </style>
</head>
<body>

  <!-- quick link to Athlete page -->
  <div style="position:fixed; top:10px; right:10px; font-size:12px; opacity:.8">
    <a href="rowxl-athlete.html" style="color:#cfe2ff">Athlete view</a>
  </div>

  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1>RowXL — Coach Inbox</h1>
      <div class="tiny" style="padding:6px 10px;border:1px solid var(--outline);border-radius:999px;background:var(--panel2)">
        Testing mode (no sign-in)
      </div>
    </div>

    <!-- ===== Inbox (videos to review) ===== -->
    <div class="panel">
      <div class="controls">
        <div class="field">
          <label for="coachInput">Coach</label>
          <input id="coachInput" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="limitSelect">Limit</label>
          <select id="limitSelect">
            <option>10</option><option selected>20</option><option>40</option><option>80</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <table id="jobs">
        <thead>
          <tr>
            <th style="width:32%">Video</th>
            <th style="width:26%">Athlete (name • email • user id)</th>
            <th style="width:10%">Boat</th>
            <th style="width:10%">Status</th>
            <th style="width:12%">Created</th>
            <th style="width:10%">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td class="empty" colspan="6">No videos yet.</td></tr>
        </tbody>
      </table>
      <div class="tiny" style="margin-top:8px">“Generate report” saves a markdown report and embeds the video link inside it.</div>
    </div>

    <!-- ===== Saved Reports ===== -->
    <h2 class="section-title">Saved Reports</h2>
    <div class="panel">
      <div class="controls" style="justify-content:space-between;gap:12px;align-items:flex-end">
        <div class="field">
          <label>&nbsp;</label>
          <button id="loadReportsBtn" class="btn">Load reports</button>
        </div>
        <div class="field" style="flex:1; min-width:260px">
          <label for="defaultAthlete">Default Athlete UUID (optional)</label>
          <input id="defaultAthlete" placeholder="d64ae833-ed5e-47ff-a43b-5ffa#..." />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <span class="tiny">Click “Share” to send a report to an athlete.</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:42%">Title</th>
            <th style="width:18%">Athlete</th>
            <th style="width:12%">Status</th>
            <th style="width:14%">Created</th>
            <th style="width:14%">Actions</th>
          </tr>
        </thead>
        <tbody id="reportsRows">
          <tr><td class="empty" colspan="5">No reports loaded.</td></tr>
        </tbody>
      </table>

      <div id="missingFnWarn" class="tiny" style="display:none;margin-top:8px;color:#ffc7c7"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    /* ===== CONFIG (testing mode; no login needed) ===== */
    const SUPABASE_URL  = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";
    const COACH_SECRET  = "abc1234";   // must match your Edge Function check
    const DEFAULT_COACH = "Noel";
    const BOATS = ["8+","4+","4x","4x-","4-","2x","2-","1x"];

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const toast = (m, ok=true)=>{
      const t=$("#toast"); if(!t) return;
      t.textContent=m; t.style.display="block";
      t.style.borderColor = ok ? "#1d5a38" : "#8b2a2a";
      clearTimeout(t._h); t._h=setTimeout(()=>t.style.display="none",2400);
    };
    const prettyDate = iso => iso ? new Date(iso).toLocaleString() : "—";
    const truncateMiddle = (str, max=64) => {
      if(!str) return "";
      if(str.length <= max) return str;
      const head = Math.ceil((max-3)/2), tail = Math.floor((max-3)/2);
      return str.slice(0, head) + "..." + str.slice(-tail);
    };
    const cleanTitleFromUrl = (url) => {
      if(!url) return "report";
      try{
        const u = new URL(url);
        const last = u.pathname.split("/").pop() || "report";
        return truncateMiddle(last, 64);
      }catch(_){ return truncateMiddle(url.split("/").pop()||"report", 64); }
    };
    const coachInput=$("#coachInput");
    coachInput.value = localStorage.getItem("coach_name") || DEFAULT_COACH;
    coachInput.addEventListener("input", ()=> localStorage.setItem("coach_name", coachInput.value.trim()));

    /* ===== Edge wrappers ===== */
    const fn = n => `${SUPABASE_URL}/functions/v1/${n}`;
    async function _fetch(name, init){
      init = init || {};
      init.headers = {
        ...(init.headers||{}),
        "Content-Type":"application/json",
        "Authorization":`Bearer ${SUPABASE_ANON}`,
        "x-coach-secret": COACH_SECRET
      };
      const res = await fetch(fn(name), init);
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        if(res.status===404){
          const w=$("#missingFnWarn");
          if(w){ w.style.display="block"; w.textContent=`Missing Edge Function “${name}”. Deploy with: supabase functions deploy ${name}`; }
        }
        throw new Error(`${name} ${res.status}: ${txt||"error"}`);
      }
      const ct = res.headers.get("content-type")||"";
      return ct.includes("application/json") ? res.json() : res.text();
    }
    const fetchInbox      = (limit=20)=> _fetch("coach-inbox",{ method:"POST", body:JSON.stringify({ limit }) });
    const generateReport  = (payload)=> _fetch("coach-generate-report",{ method:"POST", body:JSON.stringify(payload) });
    const deleteVideo     = (path)=>   _fetch("coach-delete-video",{ method:"POST", body:JSON.stringify({ path }) });
    const listReports     = (limit=200)=> _fetch(`coach-list-reports?limit=${limit}`,{ method:"GET" });
    const shareReport     = (payload)=> _fetch("coach-share-report",{ method:"POST", body:JSON.stringify(payload) });

    /* ===== Optional fallback: fetch athlete name/email from table if missing ===== */
    const athleteCache = new Map(); // user_id -> {full_name,email}
    async function fetchAthleteByUserId(user_id){
      if(!user_id) return null;
      if(athleteCache.has(user_id)) return athleteCache.get(user_id);

      // Supabase PostgREST: /rest/v1/athletes?user_id=eq.<uuid>&select=full_name,email,user_id
      const url = `${SUPABASE_URL}/rest/v1/athletes?user_id=eq.${encodeURIComponent(user_id)}&select=full_name,email,user_id`;
      const res = await fetch(url, {
        headers:{
          apikey: SUPABASE_ANON,
          Authorization: `Bearer ${SUPABASE_ANON}`,
        }
      });
      if(!res.ok) return null;
      const rows = await res.json().catch(()=>[]);
      const row = rows?.[0] || null;
      if(row) athleteCache.set(user_id, row);
      return row;
    }

    /* ===== Render: inbox ===== */
    async function renderRows(items){
      const tbody = $("#rows"); tbody.innerHTML = "";
      if (!items?.length){
        tbody.innerHTML = `<tr><td class="empty" colspan="6">No videos yet.</td></tr>`;
        return;
      }

      for(const it of items){
        const tr = document.createElement("tr");

        // Video cell
        const videoCell=document.createElement("td");
        const fileName=(it.path||it.video_path||"").split("/").pop() || it.id || "video";
        const openUrl=it.signed_url || it.signedUrl || it.url || it.video_path;
        const fname = document.createElement("div"); fname.style.fontWeight="600"; fname.className="cell-title"; fname.textContent=fileName;
        const path = document.createElement("div"); path.className="tiny mono cell-title"; path.textContent=(it.path||"").replace(/^uploads\//,"…/");
        videoCell.append(fname, path);

        // Athlete cell — live placeholders, then fallback fetch if needed
        const athleteCell=document.createElement("td");
        const nmEl   = document.createElement("div");
        const emailEl= document.createElement("div"); emailEl.className="tiny";
        const uidEl  = document.createElement("div"); uidEl.className="tiny mono"; uidEl.style.opacity=0.85;

        const initialName  = it.athlete_name || it.full_name || "";
        const initialEmail = it.athlete_email || it.email || "";
        const userId = it.user_id || it.athlete_user_id || "";

        nmEl.textContent    = initialName || "—";
        emailEl.textContent = initialEmail || "—";
        uidEl.textContent   = userId || "—";
        athleteCell.append(nmEl, emailEl, uidEl);

        // If name/email missing, try to enrich from athletes table
        if((!initialName || !initialEmail) && userId){
          fetchAthleteByUserId(userId).then(row=>{
            if(row){
              if(!initialName  && row.full_name) nmEl.textContent = row.full_name;
              if(!initialEmail && row.email)     emailEl.textContent = row.email;
            }
          }).catch(()=>{ /* ignore */ });
        }

        // Boat
        const boatCell=document.createElement("td");
        const sel=document.createElement("select");
        sel.innerHTML = `<option value="">—</option>` + BOATS.map(b=>`<option>${b}</option>`).join("");
        sel.value = it.boat || "";
        boatCell.appendChild(sel);

        // Status
        const statusCell=document.createElement("td");
        const pill=document.createElement("span"); pill.className="pill"; pill.textContent=it.job_status||it.status||"new";
        statusCell.appendChild(pill);

        // Created
        const createdCell=document.createElement("td"); createdCell.textContent=prettyDate(it.created_at||it.uploaded_at);

        // Actions
        const actionsCell=document.createElement("td"); actionsCell.className="row-actions";
        const previewBtn=document.createElement("button"); previewBtn.className="btn ghost small"; previewBtn.textContent="Preview";
        previewBtn.onclick=()=>{ if(!openUrl){ toast("No signed URL",false); return; } window.open(openUrl,"_blank"); };
        const note=document.createElement("textarea"); note.className="note"; note.placeholder="Coach notes (what you saw; what to work on)…";
        const sendBtn=document.createElement("button"); sendBtn.className="btn primary small"; sendBtn.textContent="Generate report";
        sendBtn.onclick=async()=>{
          const coach=(coachInput.value||"").trim();
          const boat=sel.value||""; const text=(note.value||"").trim();
          if(!coach) return toast("Enter coach name",false);
          if(!text)  return toast("Add notes",false);
          if(!openUrl) return toast("No signed video URL",false);
          sendBtn.disabled=true; sendBtn.textContent="Generating…";
          try{
            const r=await generateReport({
              coach_name:coach,
              coach_notes:text,
              boat,
              video_url:openUrl,
              file_path:it.path,
              athlete_user_id: userId || null,
              auto_share:false,
              delete_on_finish:false
            });
            if(r?.ok){ pill.className="pill done"; pill.textContent="report"; toast("Report saved ✔"); }
            else throw new Error(r?.error||"Failed");
          }catch(e){ toast(e.message||"Error",false); }
          finally{ sendBtn.disabled=false; sendBtn.textContent="Generate report"; }
        };
        const delBtn=document.createElement("button"); delBtn.className="btn danger small"; delBtn.textContent="Delete";
        delBtn.onclick=async()=>{
          if(!confirm(`Delete clip "${fileName}" from storage?`)) return;
          delBtn.disabled=true; delBtn.textContent="Deleting…";
          try{ await deleteVideo(it.path); tr.remove(); toast("Video deleted"); }
          catch(e){ toast(e.message||"Delete failed",false); }
          finally{ delBtn.disabled=false; delBtn.textContent="Delete"; }
        };

        actionsCell.append(previewBtn, note, sendBtn, delBtn);
        tr.append(videoCell, athleteCell, boatCell, statusCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== Render: saved reports (with tidy title/URL) ===== */
    function renderReports(items){
      const tbody=$("#reportsRows"); tbody.innerHTML="";
      if(!items?.length){
        tbody.innerHTML=`<tr><td class="empty" colspan="5">No reports found.</td></tr>`;
        return;
      }
      for(const it of items){
        const tr=document.createElement("tr");
        const titleCell=document.createElement("td"); titleCell.className="cell-title mono";
        const athleteCell=document.createElement("td"); athleteCell.className="mono";
        const statusCell=document.createElement("td");
        const createdCell=document.createElement("td");
        const actionsCell=document.createElement("td"); actionsCell.className="row-actions";

        const displayTitle = it.title ? truncateMiddle(it.title.split("/").pop(), 64)
                           : it.saved_url || it.public_url ? cleanTitleFromUrl(it.saved_url||it.public_url)
                           : it.path ? truncateMiddle((it.path||"").split("/").pop(), 64)
                           : "report";

        titleCell.textContent = displayTitle;
        athleteCell.textContent = it.athlete_user_id || "—";
        statusCell.textContent  = it.status || "done";
        createdCell.textContent = prettyDate(it.created_at);

        const link = it.saved_url || it.public_url || null;

        const openBtn=document.createElement("a");
        openBtn.className="btn small"; openBtn.textContent="Open";
        openBtn.target="_blank"; openBtn.rel="noopener"; openBtn.href=link || "#";

        const copyBtn=document.createElement("button");
        copyBtn.className="btn small"; copyBtn.textContent="Copy link";
        copyBtn.onclick=async()=>{ try{ if(!link) throw new Error("No public link on this report."); await navigator.clipboard.writeText(link); toast("Link copied ✔"); }catch(e){ toast(e.message||"Copy failed",false); } };

        const pdfBtn=document.createElement("button");
        pdfBtn.className="btn small"; pdfBtn.textContent="PDF";
        pdfBtn.onclick=()=>downloadPDF(it);

        const shareBtn=document.createElement("button");
        shareBtn.className="btn small primary"; shareBtn.textContent="Share";
        shareBtn.onclick=async()=>{
          const def=($("#defaultAthlete").value||"").trim();
          const athleteId=it.athlete_user_id || def;
          if(!athleteId) return toast("Enter athlete UUID (row or default)",false);
          const url=link; if(!url) return toast("No URL on this report.",false);
          shareBtn.disabled=true; shareBtn.textContent="Sharing…";
          try{
            const r=await shareReport({ athlete_user_id:athleteId, title:displayTitle, url, report_id:it.id||null, coach_name:(coachInput.value||null) });
            if(r?.ok) toast("Shared ✔"); else throw new Error(r?.error||"Share failed");
          }catch(e){ toast(e.message||"Share failed",false); }
          finally{ shareBtn.disabled=false; shareBtn.textContent="Share"; }
        };

        const delBtn=document.createElement("button");
        delBtn.className="btn small danger"; delBtn.textContent="Delete";
        delBtn.onclick=async()=>{
          if(!confirm(`Delete report "${displayTitle}"?`)) return;
          try{
            await _fetch("coach-delete-report",{ method:"POST", body:JSON.stringify({ id:it.id, saved_url:it.saved_url, path:it.path }) });
            tr.remove(); toast("Report deleted");
          }catch(e){ toast(e.message||"Delete failed",false); }
        };

        actionsCell.append(openBtn,copyBtn,pdfBtn,shareBtn,delBtn);
        tr.append(titleCell,athleteCell,statusCell,createdCell,actionsCell);
        tbody.appendChild(tr);
      }
    }

    /* ===== PDF helper ===== */
    async function downloadPDF(report){
      try{
        const url=report.saved_url||report.public_url; if(!url) throw new Error("No saved URL on report.");
        const md=await (await fetch(url)).text();
        const safe=md.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replace(/^### (.*)$/gm,"<h3>$1</h3>").replace(/^## (.*)$/gm,"<h2>$1</h2>").replace(/^# (.*)$/gm,"<h1>$1</h1>")
          .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br/>");
        const html=`<!doctype html><html><head><meta charset="utf-8"><title>${report.title||"RowXL Report"}</title>
<style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f7fbff}
.header{background:#0a1a2f;color:#fff;padding:24px 18px;text-align:center}.wrap{max-width:800px;margin:24px auto;background:#fff;border:1px solid #e3edf7;border-radius:14px;box-shadow:0 6px 20px rgba(10,26,47,.06)}.inner{padding:24px}
h1,h2,h3{color:#0a1a2f;margin:0 0 8px}.meta{color:#335;font-size:14px;margin-bottom:12px}hr{border:0;border-top:1px solid #e5effa;margin:18px 0}
@media print{.wrap{box-shadow:none;border:0}body{background:#fff}}</style></head><body>
<div class="header"><div style="font-weight:600">Performance Coaching Report</div></div>
<div class="wrap"><div class="inner"><h2>${(report.title||"RowXL Report").split("/").slice(-1)[0]}</h2>
<div class="meta">Coach: ${coachInput.value||"—"} • Created: ${prettyDate(report.created_at)}</div><hr/><div>${safe}</div></div></div>
<script>window.onload=()=>setTimeout(()=>window.print(),300);<\/script></body></html>`;
        const win=window.open("","_blank"); win.document.open(); win.document.write(html); win.document.close();
      }catch(e){ toast(e.message||"PDF failed",false); }
    }

    /* ===== Loaders ===== */
    async function loadInbox(){
      try{
        $("#rows").innerHTML=`<tr><td class="empty" colspan="6">Loading…</td></tr>`;
        const limit=Number($("#limitSelect").value||20);
        const data=await fetchInbox(limit);
        await renderRows(data?.items||[]);
      }catch(e){
        $("#rows").innerHTML=`<tr><td class="empty" colspan="6">Error loading inbox.</td></tr>`;
        toast(e.message||"Failed to load inbox",false);
      }
    }
    async function loadReports(){
      try{
        $("#reportsRows").innerHTML=`<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const data=await listReports(200);
        renderReports(data?.items||[]);
      }catch(e){
        $("#reportsRows").innerHTML=`<tr><td class="empty" colspan="5">Error loading reports.</td></tr>`;
        toast(e.message||"Failed to load reports",false);
      }
    }

    $("#refreshBtn").addEventListener("click", loadInbox);
    $("#limitSelect").addEventListener("change", loadInbox);
    $("#loadReportsBtn").addEventListener("click", loadReports);

    // First load
    loadInbox();
  </script>
</body>
</html>
