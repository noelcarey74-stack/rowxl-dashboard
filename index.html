<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Coach Inbox (Testing mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb; --muted:#9fb5d1; --outline:#1e3a5f; --brand:#0e3a73; --ok:#1d5a38; --bad:#8b2a2a }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }
    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{ background:var(--panel2); color:var(--text); border:1px solid var(--outline); border-radius:8px; padding:8px 10px; outline:none }
    input::placeholder,textarea::placeholder{ color:#7fa1cc }
    button{ cursor:pointer }
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px; table-layout:fixed }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline); vertical-align:middle; overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
    th{ background:#0e294c; text-align:left; color:#cfe2ff; font-weight:600 }
    tr:hover td{ background:#0e2543 }
    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .note{ width:220px; height:46px; resize:vertical }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }
    .empty{ color:var(--muted); padding:18px }
    .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; text-decoration:none; color:#e9f0fb; background:transparent }
    .btn.primary{ background:var(--brand); border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.ghost{ opacity:.85 }
    .btn.small{ padding:6px 8px; font-size:12px }
    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    .badge{ font-size:12px; padding:4px 8px; border:1px solid var(--outline); border-radius:999px; background:var(--panel2) }
    @media (max-width: 900px){
      .note{ width:160px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1>RowXL — Coach Inbox</h1>
      <div class="badge">Testing mode (no sign-in)</div>
    </div>

    <!-- ===== Inbox (videos to review) ===== -->
    <div class="panel">
      <div class="controls">
        <div class="field">
          <label for="coachInput">Coach</label>
          <input id="coachInput" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="limitSelect">Limit</label>
          <select id="limitSelect"><option>10</option><option selected>20</option><option>40</option><option>80</option></select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40%">Video</th>
            <th style="width:20%">Athlete (User ID)</th>
            <th style="width:10%">Boat</th>
            <th style="width:12%">Status</th>
            <th style="width:18%">Created</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td class="empty" colspan="5">No videos yet.</td></tr></tbody>
      </table>
      <div class="empty" style="border-top:1px dashed var(--outline);margin-top:8px;padding-top:8px">
        “Generate report” saves a markdown report to Storage and (optionally) DB. Use “Share” below to send it to the athlete.
      </div>
    </div>

    <!-- ===== Saved Reports ===== -->
    <h2 class="section-title">Saved Reports</h2>
    <div class="panel">
      <div class="controls" style="justify-content:space-between;gap:12px;align-items:flex-end">
        <div class="field"><label>&nbsp;</label><button id="loadReportsBtn" class="btn">Load reports</button></div>
        <div class="field" style="flex:1;min-width:260px">
          <label for="defaultAthlete">Default Athlete UUID (optional)</label>
          <input id="defaultAthlete" placeholder="d64ae833-ed5e-47ff-a43b-5ffa#..." />
        </div>
        <div class="field"><label>&nbsp;</label><span style="color:#9fb5d1;font-size:12px">Click “Share” to deliver a report to an athlete.</span></div>
      </div>

      <table>
        <thead><tr>
          <th style="width:32%">Title</th>
          <th style="width:18%">Athlete</th>
          <th style="width:10%">Status</th>
          <th style="width:18%">Created</th>
          <th style="width:22%">Actions</th>
        </tr></thead>
        <tbody id="reportsRows"><tr><td class="empty" colspan="5">No reports loaded.</td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    /* ================== TESTING CONFIG (no login) ================== */
    const SUPABASE_URL  = "https://cketlapkaqmhtmthxozu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA";
    const COACH_SECRET  = "abc1234"; // must match your Edge Function secret

    const BOATS = ["8+","4+","4x","4x-","4-","2x","2-","1x"];
    const DEFAULT_COACH = "Noel";

    /* =========================== UI helpers =========================== */
    const $ = s => document.querySelector(s);
    const toast = (m, ok=true)=>{ const t=$("#toast"); if(!t) return;
      t.textContent=m; t.style.display='block'; t.style.borderColor= ok?'#1d5a38':'#8b2a2a';
      clearTimeout(t._hide); t._hide=setTimeout(()=>t.style.display='none',2400);
    };
    const prettyDate = iso => iso ? new Date(iso).toLocaleString() : "—";
    const coachInput = $("#coachInput"); coachInput.value = localStorage.getItem("coach_name") || DEFAULT_COACH;
    coachInput.addEventListener("input", ()=>localStorage.setItem("coach_name", coachInput.value.trim()));

    /* ======================= Edge function callers ======================= */
    const fn = name => `${SUPABASE_URL}/functions/v1/${name}`;
    const commonHeaders = { "Authorization": `Bearer ${SUPABASE_ANON}`, "x-coach-secret": COACH_SECRET };

    async function fetchInbox(limit=20){
      const res = await fetch(fn("coach-inbox"), {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...commonHeaders },
        body: JSON.stringify({ limit })
      });
      if(!res.ok) throw new Error(await res.text()); return res.json();
    }

    async function generateReport({ file_path, video_url, coach_name, coach_notes, boat }){
      const res = await fetch(fn("coach-generate-report"), {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...commonHeaders },
        body: JSON.stringify({ coach_name, coach_notes, boat, video_url, file_path, auto_share:false, delete_on_finish:false })
      });
      if(!res.ok) throw new Error(await res.text()); return res.json();
    }

    async function deleteVideo(path){
      const res = await fetch(fn("coach-delete-video"), {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...commonHeaders },
        body: JSON.stringify({ path })
      });
      if(!res.ok) throw new Error(await res.text()); return res.json();
    }

    async function listReports(limit=200){
      const res = await fetch(fn("coach-list-reports")+`?limit=${limit}`, { headers:{ ...commonHeaders } });
      if(!res.ok) throw new Error(await res.text()); return res.json();
    }

    async function shareReport({ athlete_user_id, title, url, report_id }){
      const res = await fetch(fn("coach-share-report"), {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...commonHeaders },
        body: JSON.stringify({ athlete_user_id, title, url, report_id })
      });
      if(!res.ok) throw new Error(await res.text()); return res.json();
    }

    /* ========================= Render: Inbox rows ========================= */
    function renderRows(items){
      const tbody = $("#rows"); tbody.innerHTML='';
      if(!items?.length){ tbody.innerHTML=`<tr><td class="empty" colspan="5">No videos yet.</td></tr>`; return; }

      for(const it of items){
        const tr = document.createElement("tr");

        const openUrl = it.signed_url || it.signedUrl || it.url || it.video_path || null;
        const videoName = (it.path||it.video_path||"").split("/").pop() || "video";
        const athleteId = it.athlete_user_id || it.user_id || "";

        // Video
        const c1 = document.createElement("td");
        c1.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
            <div style="width:10px;height:10px;border-radius:50%;background:#3d7cff"></div>
            <div style="font-weight:600">${videoName}</div>
            <button class="btn ghost small" style="margin-left:10px">Preview</button>
          </div>`;
        c1.querySelector("button").onclick = ()=>{ if(!openUrl){ toast("No signed URL.",false); return; } window.open(openUrl,"_blank"); };

        // Athlete
        const c2 = document.createElement("td"); c2.textContent = athleteId || "—";

        // Boat
        const c3 = document.createElement("td");
        const sel = document.createElement("select");
        sel.innerHTML = `<option value="">—</option>` + BOATS.map(b=>`<option>${b}</option>`).join("");
        sel.value = it.boat || ""; c3.appendChild(sel);

        // Status
        const c4 = document.createElement("td");
        const pill = document.createElement("span"); pill.className="pill"; pill.textContent = it.job_status || it.status || "new";
        c4.appendChild(pill);

        // Created + actions stacked
        const c5 = document.createElement("td");
        const created = prettyDate(it.created_at || it.uploaded_at);
        c5.innerHTML = `<div>${created}</div>`;
        const actions = document.createElement("div"); actions.className="row-actions"; actions.style.marginTop="6px";

        const note = document.createElement("textarea"); note.className="note"; note.placeholder="Coach notes…";
        const genBtn = document.createElement("button"); genBtn.className="btn primary small"; genBtn.textContent="Generate report";
        const delBtn = document.createElement("button"); delBtn.className="btn danger small"; delBtn.textContent="Delete";

        genBtn.onclick = async ()=>{
          const coach = (coachInput.value||"").trim();
          const boat = sel.value || "";
          const text = (note.value||"").trim();
          if(!coach) return toast("Enter coach name.",false);
          if(!text)  return toast("Write a quick note.",false);
          if(!openUrl) return toast("No signed video URL.",false);

          genBtn.disabled=true; genBtn.textContent="Saving…";
          try{
            const r = await generateReport({ file_path: it.path, video_url: openUrl, coach_name: coach, coach_notes: text, boat });
            if(r?.ok){ pill.className="pill done"; pill.textContent="report"; toast("Report saved ✔"); }
            else throw new Error(r?.error||"Failed");
          }catch(e){ toast(e.message||"Error",false); }
          finally{ genBtn.disabled=false; genBtn.textContent="Generate report"; }
        };

        delBtn.onclick = async ()=>{
          if(!confirm(`Delete clip “${videoName}” from storage?`)) return;
          delBtn.disabled=true; delBtn.textContent="Deleting…";
          try{ await deleteVideo(it.path); tr.remove(); toast("Video deleted"); }
          catch(e){ toast(e.message||"Delete failed",false); }
          finally{ delBtn.disabled=false; delBtn.textContent="Delete"; }
        };

        actions.append(note, genBtn, delBtn);
        c5.appendChild(actions);

        tr.append(c1,c2,c3,c4,c5);
        tbody.appendChild(tr);
      }
    }

    /* ======================== Render: Saved reports ======================== */
    function renderReports(items){
      const tbody = $("#reportsRows"); tbody.innerHTML='';
      if(!items?.length){ tbody.innerHTML=`<tr><td class="empty" colspan="5">No reports found.</td></tr>`; return; }

      for(const it of items){
        const tr = document.createElement("tr");
        const title = (it.title || it.saved_url || it.path || "").split("/").slice(-1)[0] || "report";
        const athlete = it.athlete_user_id || "—";
        const created = prettyDate(it.created_at);

        const c1=document.createElement("td"); c1.textContent = title;
        const c2=document.createElement("td"); c2.textContent = athlete;
        const c3=document.createElement("td"); c3.textContent = it.status || "done";
        const c4=document.createElement("td"); c4.textContent = created;

        const c5=document.createElement("td"); c5.className="row-actions";
        const openBtn=document.createElement("a"); openBtn.className="btn small"; openBtn.textContent="Open"; openBtn.target="_blank"; openBtn.rel="noopener"; openBtn.href=it.saved_url||it.public_url||"#";
        const copyBtn=document.createElement("button"); copyBtn.className="btn small"; copyBtn.textContent="Copy link";
        copyBtn.onclick=async()=>{ try{ const link=it.saved_url||it.public_url; if(!link) throw new Error("No link"); await navigator.clipboard.writeText(link); toast("Link copied ✔"); }catch(e){ toast(e.message||"Copy failed",false); } };
        const pdfBtn=document.createElement("button"); pdfBtn.className="btn small"; pdfBtn.textContent="PDF"; pdfBtn.onclick=()=>downloadPDF(it);

        const shareBtn=document.createElement("button"); shareBtn.className="btn small primary"; shareBtn.textContent="Share";
        shareBtn.onclick=async()=>{ const athleteId = it.athlete_user_id || ($("#defaultAthlete").value||"").trim();
          if(!athleteId) return toast("Set athlete UUID to share.",false);
          const url = it.saved_url || it.public_url; if(!url) return toast("No URL on this report.",false);
          shareBtn.disabled=true; shareBtn.textContent="Sharing…";
          try{ const r = await shareReport({ athlete_user_id: athleteId, title, url, report_id: it.id||null }); if(r?.ok) toast("Shared with athlete ✔"); else throw new Error(r?.error||"Share failed"); }
          catch(e){ toast(e.message||"Share failed",false); }
          finally{ shareBtn.disabled=false; shareBtn.textContent="Share"; }
        };

        const delBtn=document.createElement("button"); delBtn.className="btn small danger"; delBtn.textContent="Delete";
        delBtn.onclick=async()=>{ if(!confirm(`Delete report “${title}”?`)) return;
          try{ const res = await fetch(fn("coach-delete-report"), { method:"POST", headers:{ "Content-Type":"application/json", ...commonHeaders }, body: JSON.stringify({ id: it.id, saved_url: it.saved_url, path: it.path }) });
               if(!res.ok) throw new Error(await res.text()); tr.remove(); toast("Report deleted"); }
          catch(e){ toast(e.message||"Delete failed",false); } };

        c5.append(openBtn,copyBtn,pdfBtn,shareBtn,delBtn);
        tr.append(c1,c2,c3,c4,c5);
        tbody.appendChild(tr);
      }
    }

    /* =========================== PDF generator =========================== */
    async function downloadPDF(report){
      try{
        const url = report.saved_url || report.public_url; if(!url) throw new Error("No saved URL on report.");
        const md = await (await fetch(url)).text();
        const safe = md.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
          .replace(/^### (.*)$/gm,'<h3>$1</h3>').replace(/^## (.*)$/gm,'<h2>$1</h2>').replace(/^# (.*)$/gm,'<h1>$1</h1>')
          .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br/>');
        const created=prettyDate(report.created_at);
        const logo=`${SUPABASE_URL}/storage/v1/object/public/reports/branding/logo.png`;
        const html=`<!doctype html><html><head><meta charset="utf-8"><title>${report.title||'RowXL Report'}</title>
<style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f7fbff}
.header{background:#0a1a2f;color:#fff;padding:24px 18px;text-align:center}.header img{height:40px;display:block;margin:0 auto 8px}
.wrap{max-width:800px;margin:24px auto;background:#fff;border:1px solid #e3edf7;border-radius:14px;box-shadow:0 6px 20px rgba(10,26,47,.06)}
.inner{padding:24px}h1,h2,h3{color:#0a1a2f;margin:0 0 8px}.meta{color:#335;font-size:14px;margin-bottom:12px}hr{border:0;border-top:1px solid #e5effa;margin:18px 0}
@media print{.wrap{box-shadow:none;border:0}body{background:#fff}}</style></head><body>
<div class="header"><img src="${logo}" alt="RowXL"><div>Performance Coaching Report</div></div>
<div class="wrap"><div class="inner"><h2>${(report.title||'RowXL Report').split('/').slice(-1)[0]}</h2>
<div class="meta">Coach: ${coachInput.value || '—'} • Created: ${created}</div><hr/><div>${safe}</div></div></div>
<script>window.onload=()=>setTimeout(()=>window.print(),300);<\/script></body></html>`;
        const win=window.open('','_blank'); win.document.open(); win.document.write(html); win.document.close();
      }catch(e){ toast(e.message||'PDF failed',false); }
    }

    /* ============================= Wiring ============================= */
    async function loadInbox(){
      try{
        $("#rows").innerHTML = `<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const limit = Number($("#limitSelect").value||20);
        const data = await fetchInbox(limit);
        renderRows(data?.items||data?.data||[]);
      }catch(e){
        $("#rows").innerHTML = `<tr><td class="empty" colspan="5">Error loading inbox.</td></tr>`;
        toast(`Inbox: ${e.message||e}`, false);
      }
    }
    async function loadReports(){
      try{
        $("#reportsRows").innerHTML = `<tr><td class="empty" colspan="5">Loading…</td></tr>`;
        const data = await listReports(200);
        renderReports(data?.items||data?.data||[]);
      }catch(e){
        $("#reportsRows").innerHTML = `<tr><td class="empty" colspan="5">Error loading reports.</td></tr>`;
        toast(`Reports: ${e.message||e}`, false);
      }
    }

    $("#refreshBtn").addEventListener("click", loadInbox);
    $("#limitSelect").addEventListener("change", loadInbox);
    $("#loadReportsBtn").addEventListener("click", loadReports);

    // first load
    loadInbox();
  </script>
</body>
</html>
