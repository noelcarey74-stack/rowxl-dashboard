<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Coach Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Config passed safely via JSON -->
  <script id="rowxl-config" type="application/json">{
    "SUPABASE_URL": "https://cketlapkaqmhtmthxozu.supabase.co",
    "SUPABASE_ANON": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXRsYXBrYXFtaHRtdGh4b3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjIwMzgsImV4cCI6MjA3NzMzODAzOH0.wfmjPBb-7cNpmlV2JByRHGAwkKjsrK7fHd2D7wlf5oA",
    "COACH_SECRET": "abc1234"
  }</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root{ --bg:#0a1a2f; --panel:#0f2747; --panel2:#113057; --text:#e9f0fb; --muted:#9fb5d1; --outline:#1e3a5f; --brand:#0e3a73; --ok:#1d5a38; --bad:#8b2a2a }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif }
    a{ color:#cfe2ff }
    .wrap{ max-width:1200px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 18px; font-size:28px }
    .panel{ background:var(--panel); border:1px solid var(--outline); border-radius:10px; padding:14px }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:14px }
    .field{ display:flex; flex-direction:column; min-width:140px }
    label{ font-size:12px; color:var(--muted); margin:0 0 4px }
    input,select,button,textarea{ background:var(--panel2); color:var(--text); border:1px solid var(--outline); border-radius:8px; padding:8px 10px; outline:none }
    button{ cursor:pointer }
    .btn{ padding:8px 10px; border:1px solid var(--outline); border-radius:8px; color:#e9f0fb; background:transparent }
    .btn.primary{ background:var(--brand); border-color:#205b9a }
    .btn.danger{ border-color:#7a2b2b; background:#3b1d1d }
    .btn.small{ padding:6px 8px; font-size:12px }
    .section-title{ margin:24px 0 10px; font-size:20px; color:#dbe8ff }
    table{ width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden }
    th,td{ padding:12px 10px; border-bottom:1px solid var(--outline); white-space:nowrap; text-overflow:ellipsis; overflow:hidden }
    th{ background:#0e294c; text-align:left; color:#cfe2ff }
    tr:hover td{ background:#0e2543 }
    .empty{ color:var(--muted); padding:18px }
    .toast{ position:fixed; right:14px; bottom:14px; background:#113057; border:1px solid var(--outline); padding:10px 12px; border-radius:10px; display:none }
    .topbar{ background:var(--panel); border-bottom:1px solid var(--outline); position:sticky; top:0 }
    .topbar-inner{ max-width:1200px; margin:0 auto; padding:10px 20px; display:flex; justify-content:space-between; align-items:center }
    .tiny{ font-size:12px; color:var(--muted) }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--outline); color:#b8d2ff }
    .pill.done{ background:#113e22; border-color:#1d5a38; color:#bff3d3 }
    .pill.err{ background:#3b1d1d; border-color:#7a2b2b; color:#ffc7c7 }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div><strong>RowXL</strong> <span class="tiny">Coach Inbox</span></div>
      <div class="tiny">Testing mode (no sign-in)</div>
    </div>
  </div>

  <div class="wrap">
    <h1>RowXL — Coach Inbox</h1>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <label>Search</label>
          <input id="searchInput" placeholder="Filename, athlete name, or user ID" />
        </div>
        <div class="field">
          <label>Coach</label>
          <input id="coachInput" placeholder="Your name" value="Noel" />
        </div>
        <div class="field">
          <label>Limit</label>
          <select id="limitSelect"><option>10</option><option selected>20</option><option>50</option></select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <table id="inboxTable">
        <thead>
          <tr>
            <th style="width:30%">Video</th>
            <th style="width:25%">Athlete (Name • User ID)</th>
            <th style="width:15%">Boat</th>
            <th style="width:10%">Status</th>
            <th style="width:20%">Created</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td class="empty" colspan="5">No videos yet.</td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // Config
    function getConfig(key){try{return JSON.parse(document.getElementById('rowxl-config').textContent||'{}')[key]}catch{return''}}
    const SUPABASE_URL=getConfig('SUPABASE_URL'), SUPABASE_ANON=getConfig('SUPABASE_ANON'), COACH_SECRET=getConfig('COACH_SECRET')
    const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON)
    const $=s=>document.querySelector(s)
    const toast=(m,o=true)=>{const t=$('#toast');t.textContent=m;t.style.display='block';t.style.borderColor=o?'#1d5a38':'#8b2a2a';clearTimeout(t._h);t._h=setTimeout(()=>t.style.display='none',2400)}
    const prettyDate=i=>i?new Date(i).toLocaleString():'—'

    async function loadInbox(){
      try{
        const lim=$('#limitSelect').value, q=$('#searchInput').value.trim()
        const r=await fetch(`${SUPABASE_URL}/functions/v1/coach-inbox`,{
          method:'POST',headers:{'Content-Type':'application/json','x-coach-secret':COACH_SECRET},
          body:JSON.stringify({limit:lim,q})
        })
        if(!r.ok)throw new Error(await r.text())
        const d=await r.json(), items=d.items||[]
        const tb=$('#rows');tb.innerHTML=''
        if(!items.length){tb.innerHTML='<tr><td class="empty" colspan="5">No videos found.</td></tr>';return}
        for(const it of items){
          const tr=document.createElement('tr')
          tr.innerHTML=`<td>${it.file_name}</td>
            <td>${(it.athlete_name||'—')} ${it.user_id?`• ${it.user_id}`:''}</td>
            <td>${it.boat||'—'}</td>
            <td><span class="pill ${it.job_status?.includes('done')?'done':''}">${it.job_status||'new'}</span></td>
            <td>${prettyDate(it.created_at)}</td>`
          tb.appendChild(tr)
        }
      }catch(e){toast(e.message,false)}
    }

    $('#refreshBtn').onclick=loadInbox
    $('#limitSelect').onchange=loadInbox
    $('#searchInput').oninput=loadInbox
    loadInbox()
  </script>
</body>
</html>
