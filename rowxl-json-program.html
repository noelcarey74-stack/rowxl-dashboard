<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL â€” Program Text Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0f172a;
      --panel2:#020617;
      --text:#e5f0ff;
      --muted:#9fb5d1;
      --outline:#1e3a5f;
      --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:radial-gradient(circle at top,#0b1530 0,#020617 55%,#000 100%);
      color:var(--text);
      font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 10px; font-size:28px }

    .panel{
      background:var(--panel);
      border:1px solid var(--outline);
      border-radius:14px;
      padding:16px;
    }

    .layout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }

    @media (max-width:900px){
      .layout{ grid-template-columns:1fr }
    }

    label{ font-size:12px; color:var(--muted); margin:0 0 4px; display:block }

    textarea{
      width:100%;
      min-height:360px;
      resize:vertical;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--outline);
      border-radius:10px;
      padding:10px;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      outline:none;
    }
    textarea::placeholder{ color:#64748b }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--outline);
      background:rgba(15,23,42,.9);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.primary{
      background:linear-gradient(135deg,#0ea5e9,#2563eb);
      border-color:#2563eb;
      color:#e5f0ff;
    }
    .btn.ghost{ background:transparent; opacity:.9 }
    .btn:disabled{ opacity:.6; cursor:default }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .tiny{ font-size:12px; color:var(--muted); margin-top:8px }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#0f172a;
      border:1px solid var(--outline);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:50;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RowXL â€” Program Text Generator</h1>
    <div class="tiny">
      Paste the JSON you receive from the Program Builder on the left, then click
      <strong>Generate diary</strong>. A full day-by-day training diary will appear on the right for you to copy.
    </div>

    <div class="panel" style="margin-top:18px">
      <div class="layout">
        <!-- LEFT: JSON INPUT -->
        <div>
          <label for="inputJson">Program JSON</label>
          <textarea id="inputJson" spellcheck="false" placeholder='Paste JSON from Program Builder here...'></textarea>
          <div class="controls-row">
            <button id="loadSampleBtn" class="btn ghost" type="button">Load sample JSON</button>
            <button id="generateBtn" class="btn primary" type="button">Generate diary</button>
          </div>
        </div>

        <!-- RIGHT: DIARY OUTPUT -->
        <div>
          <label for="outputDiary">Generated Training Diary (copy &amp; paste)</label>
          <textarea id="outputDiary" spellcheck="false" placeholder="Your program diary will appear here..."></textarea>
          <div class="controls-row">
            <button id="copyDiaryBtn" class="btn ghost" type="button">Copy diary</button>
            <button id="clearBtn" class="btn ghost" type="button">Clear</button>
          </div>
          <div class="tiny">
            Every day will include: Warm-up, Main Set, Stroke Rate/HR zone (where relevant),
            Technical Focus, Notes, and an Athlete Notes section. A short summary will be added at the end.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = s => document.querySelector(s);
    const toast = (msg, ok=true)=>{
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      t.style.borderColor = ok ? "#16a34a" : "#b91c1c";
      clearTimeout(t._h);
      t._h = setTimeout(()=>{ t.style.display="none"; }, 2600);
    };

    // ---- SAMPLE JSON (matches what your Program Builder sends) ----
    const SAMPLE = JSON.stringify({
      "notes": "Iâ€™m doing a 1k test at the end of the program",
      "gender": "Male",
      "category": "Masters",
      "start_date": "2025-11-26",
      "finish_date": "2025-12-01",
      "athlete_name": "Noel Carey",
      "athlete_email": "noelcarey74@yahoo.ie",
      "weekly_schedule": {
        "Fri": "Water Row",
        "Mon": "Erg (UT2)",
        "Sat": "Weights",
        "Sun": "Erg (UT1/AT)",
        "Thu": "Water Row",
        "Tue": "Weights",
        "Wed": "Rest"
      },
      "intensity_percent": 75
    }, null, 2);

    $("#loadSampleBtn").addEventListener("click", ()=>{
      $("#inputJson").value = SAMPLE;
      toast("Sample JSON loaded");
    });

    $("#clearBtn").addEventListener("click", ()=>{
      $("#inputJson").value = "";
      $("#outputDiary").value = "";
    });

    $("#copyDiaryBtn").addEventListener("click", async ()=>{
      const text = $("#outputDiary").value;
      if (!text.trim()) { toast("Nothing to copy", false); return; }
      try{
        await navigator.clipboard.writeText(text);
        toast("Diary copied âœ”");
      }catch(e){
        toast("Copy failed", false);
      }
    });

    // ---------- JSON NORMALISATION ----------
    function normalisePayload(raw){
      // Athlete block
      const athlete = raw.athlete ? {...raw.athlete} : {};
      if (!athlete.name && raw.athlete_name) athlete.name = raw.athlete_name;
      if (!athlete.email && raw.athlete_email) athlete.email = raw.athlete_email;
      if (!athlete.gender && raw.gender) athlete.gender = raw.gender;
      if (!athlete.category && raw.category) athlete.category = raw.category;

      // Program block (accept both nested + flat fields)
      const program = raw.program ? {...raw.program} : {};
      if (!program.start_date && raw.start_date) program.start_date = raw.start_date;
      if (!program.end_date && (raw.finish_date || raw.end_date)) {
        program.end_date = raw.finish_date || raw.end_date;
      }
      if (program.intensity_percent == null && raw.intensity_percent != null) {
        program.intensity_percent = raw.intensity_percent;
      }
      if (!program.weekly_schedule && raw.weekly_schedule) {
        program.weekly_schedule = raw.weekly_schedule;
      }
      if (!program.focus && raw.focus) program.focus = raw.focus;
      if (!program.notes && raw.notes) program.notes = raw.notes;

      const title = raw.title ||
        `${athlete.category || "Masters"}${athlete.gender ? " â€“ " + athlete.gender : ""} Training Diary`.trim();
      const quote = raw.quote || "Consistency builds champions.";

      return { title, athlete, program, quote };
    }

    function parseISODate(str){
      const parts = String(str).split("-");
      if (parts.length !== 3) return null;
      const y = parseInt(parts[0],10);
      const m = parseInt(parts[1],10);
      const d = parseInt(parts[2],10);
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }

    function formatDateLong(d){
      return d.toLocaleDateString("en-GB", {
        weekday:"long",
        day:"numeric",
        month:"long",
        year:"numeric"
      });
    }

    function formatDateShort(d){
      return d.toISOString().slice(0,10);
    }

    const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    // ---------- INTRO ----------
    function buildIntro(meta){
      const { title, athlete, program, quote } = meta;
      const start = program.start_date;
      const end   = program.end_date;
      const cat   = athlete.category || "Masters";
      const gender = athlete.gender || "";
      const intensity = program.intensity_percent ?? 75;
      const focus = program.focus || "Aerobic base and technical consistency";

      const weekly = program.weekly_schedule || {};
      const weeklyLines = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(
        d=>`${d} ${weekly[d] || "Rest"}`
      );

      return [
        `${title}`,
        `Dates: ${start} â†’ ${end}`,
        `Category: ${cat}${gender ? " ("+gender+")" : ""}`,
        `Intensity Level: ~${intensity}%`,
        `Primary Focus: ${focus}`,
        ``,
        `Weekly Structure:`,
        ...weeklyLines,
        ``,
        `Quote:`,
        `â€œ${quote}â€`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // ---------- DAY TEMPLATES ----------
    function templateRest(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `None planned.`,
        ``,
        `Main Set:`,
        `Rest day.`,
        ``,
        `Focus:`,
        `Recovery, sleep and general mobility.`,
        ``,
        `Notes:`,
        `Light walking or gentle stretching is encouraged, but no structured training is required.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateWaterRow(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10â€“15 minutes light paddling, building gradually from very easy to steady rowing.`,
        `Include 3 Ã— 10 stroke builds up to 22â€“24 spm with plenty of paddling between.`,
        ``,
        `Main Set:`,
        `Option A â€“ continuous:`,
        `â€¢ 40â€“50 minutes steady rowing.`,
        ``,
        `Option B â€“ broken:`,
        `â€¢ 2 Ã— 20â€“25 minutes with 3 minutes light paddling between pieces.`,
        `Stroke Rate: 18â€“22 spm`,
        `Heart Rate: UT2 to light UT1 (roughly 60â€“75% HR max).`,
        ``,
        `Technical Focus:`,
        `â€¢ Clean, quiet catches with the blade fully loaded before the drive.`,
        `â€¢ Strong leg drive while the upper body stays relaxed and supported.`,
        `â€¢ Level hands at the finish and tidy, consistent tap-down.`,
        ``,
        `Focus:`,
        `Boat run, timing and aerobic efficiency with no rush on the slide.`,
        ``,
        `Notes:`,
        `If conditions are poor, shorten the main set slightly but keep it controlled and safe. Prioritise timing and balance over power.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateWeights(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5â€“8 minutes light cardio (row, cycle or treadmill) plus dynamic mobility for hips, hamstrings, shoulders and back.`,
        ``,
        `Main Set:`,
        `Block A`,
        `â€¢ Goblet Squat â€“ 3 Ã— 10`,
        `â€¢ Romanian Deadlift â€“ 3 Ã— 8`,
        ``,
        `Block B`,
        `â€¢ Lat Pulldown or Assisted Pull-down â€“ 3 Ã— 10`,
        `â€¢ Dumbbell Bench Press â€“ 3 Ã— 8`,
        ``,
        `Block C`,
        `â€¢ Seated or Cable Row â€“ 3 Ã— 10`,
        `â€¢ Front Plank â€“ 3 Ã— 30â€“40 seconds`,
        ``,
        `Rest:`,
        `60â€“90 seconds between working sets.`,
        ``,
        `Technical Focus:`,
        `â€¢ Neutral spine at all times (no rounding).`,
        `â€¢ Drive from the legs and hips rather than the lower back.`,
        `â€¢ Smooth, controlled lowering phase; strong but not jerky on the way up.`,
        ``,
        `Focus:`,
        `Maintain rowing-specific strength and robustness without creating heavy fatigue.`,
        ``,
        `Notes:`,
        `Choose loads that feel â€œcomfortably hardâ€ on the last 2 reps but always leave 1â€“2 good reps in reserve.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateErgUT2(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes very easy rowing, gradually building from light paddling to a steady UT2 rhythm.`,
        ``,
        `Main Set:`,
        `2 Ã— 40 minutes continuous UT2 rowing.`,
        `Stroke Rate: 18â€“20 spm`,
        `Heart Rate: 60â€“70% HR max (easy conversational effort).`,
        `Rest: 3 minutes very light paddling between pieces.`,
        ``,
        `Technical Focus:`,
        `â€¢ Long, relaxed stroke with quiet shoulders.`,
        `â€¢ Strong connection through the legs before the body and arms.`,
        `â€¢ Smooth, unhurried recovery with balanced posture on the slide.`,
        ``,
        `Focus:`,
        `Aerobic conditioning and rhythm at approximately 75% effort, without chasing split.`,
        ``,
        `Notes:`,
        `You should always feel that you could continue another 10â€“15 minutes at the end of each piece.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateErgUT1AT(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes light rowing, gradually building from UT2 into the lower end of UT1 (20â€“22 spm).`,
        ``,
        `Main Set:`,
        `3 Ã— 8â€“10 minutes at UT1 / AT (comfortably hard).`,
        `Stroke Rate: 22â€“26 spm.`,
        `Rest: 3â€“4 minutes very light paddling between pieces.`,
        ``,
        `Technical Focus:`,
        `â€¢ Powerful but relaxed leg drive; stay tall through the trunk.`,
        `â€¢ Keep the handle speed smooth into and away from the body.`,
        `â€¢ No rushing on the slide, even when the rate is high.`,
        ``,
        `Focus:`,
        `Build threshold fitness while keeping the stroke long and tidy.`,
        ``,
        `Notes:`,
        `You should feel challenged but in control. You should not be completely empty at the end.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // ---------- SUMMARY AT END ----------
    function buildSummary(meta){
      const { athlete, program } = meta;
      const start = parseISODate(program.start_date);
      const end   = parseISODate(program.end_date);
      if (!start || !end) return "";

      const days = Math.round((end - start) / (1000*60*60*24)) + 1;
      const weekly = program.weekly_schedule || {};
      const focus  = program.focus || "Aerobic base and technical consistency";
      const intensity = program.intensity_percent ?? 75;
      const notesRaw = String(program.notes || "").trim();

      const weeklyLine = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
        .map(d => `${d}: ${weekly[d] || "Rest"}`)
        .join("; ");

      const summaryLines = [
        `End-of-Block Summary`,
        ``,
        `â€¢ Duration: ${days} day(s) from ${program.start_date} to ${program.end_date}.`,
        `â€¢ Athlete: ${athlete.name || "â€”"} (${athlete.category || "Masters"}${athlete.gender ? ", " + athlete.gender : ""}).`,
        `â€¢ Focus: ${focus}.`,
        `â€¢ Planned intensity: around ${intensity}%.`,
        `â€¢ Weekly pattern: ${weeklyLine}.`
      ];

      // ---- Intelligent handling of notes ----
      if (notesRaw){
        const notes = notesRaw;
        const lower = notes.toLowerCase();

        // Helper to avoid dumping a huge paragraph into one bullet
        const shortNote = notes.length > 160 ? notes.slice(0,157) + "â€¦" : notes;

        const hasTest =
          lower.includes("1k") || lower.includes("2k") || lower.includes("5k") ||
          lower.includes("test") || lower.includes("time trial") || lower.includes("tt");

        const hasRace =
          lower.includes("regatta") || lower.includes("head") || lower.includes("horr") ||
          lower.includes("race") || lower.includes("championship") ||
          lower.includes("wrmr") || lower.includes("worlds") ||
          lower.includes("henley") || lower.includes("irish champs");

        const hasInjury =
          lower.includes("injury") || lower.includes("injured") ||
          lower.includes("back") || lower.includes("shoulder") ||
          lower.includes("knee") || lower.includes("hip") ||
          lower.includes("rib") || lower.includes("ribs") ||
          lower.includes("wrist") || lower.includes("elbow") ||
          lower.includes("neck") || lower.includes("tendon") ||
          lower.includes("strain") || lower.includes("sprain") ||
          lower.includes("tear") || lower.includes("pulled") ||
          lower.includes("surgery") || lower.includes("operation") ||
          lower.includes("ill") || lower.includes("sick") ||
          lower.includes("flu") || lower.includes("covid");

        const hasScheduleIssue =
          lower.includes("holiday") || lower.includes("vacation") ||
          lower.includes("travel") || lower.includes("away") ||
          lower.includes("work") || lower.includes("shift") ||
          lower.includes("on call") || lower.includes("busy") ||
          lower.includes("kids") || lower.includes("children") ||
          lower.includes("school") || lower.includes("exam") ||
          lower.includes("exams") || lower.includes("wedding");

        if (hasTest){
          summaryLines.push(
            `â€¢ Athlete note (test): ${shortNote}`,
            `â€¢ Coach attention: A performance test is planned near the end of this block. Use the hard erg and water sessions to rehearse pacing and race rhythm.`
          );
        }

        if (hasRace){
          summaryLines.push(
            `â€¢ Athlete note (race/regatta): ${shortNote}`,
            `â€¢ Coach attention: Upcoming racing is mentioned. In the final few sessions, prioritise good execution, rest and confidence over adding extra volume.`
          );
        }

        if (hasInjury){
          summaryLines.push(
            `â€¢ Athlete note (injury/illness): ${shortNote}`,
            `â€¢ Coach attention: Possible injury or illness flagged. Consider reducing load, extending warm-ups and monitoring symptoms closely.`
          );
        }

        if (hasScheduleIssue){
          summaryLines.push(
            `â€¢ Athlete note (schedule): ${shortNote}`,
            `â€¢ Coach attention: There may be constraints on training time in this block. Be flexible with session order and protect the key quality days.`
          );
        }

        // If none of the patterns matched, just show the note plainly
        if (!hasTest && !hasRace && !hasInjury && !hasScheduleIssue){
          summaryLines.push(`â€¢ Athlete note: ${shortNote}`);
        }
      }

      summaryLines.push(
        ``,
        `Coach tip: Review how each session felt, especially the harder erg and water days, and adjust the next block based on how well you handled this load.`,
        ``,
        `------------------------------------------------------------`
      );

      return "\n" + summaryLines.join("\n") + "\n";
    }

    // ---------- DIARY BUILDER ----------
    function buildDiary(meta){
      const { program } = meta;
      const start = parseISODate(program.start_date);
      const end   = parseISODate(program.end_date);

      if (!start || !end) {
        throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
      }
      if (end < start){
        throw new Error("end_date / finish_date is before start_date.");
      }

      const weekly = program.weekly_schedule || {};
      let out = buildIntro(meta);

      const cur = new Date(start.getTime());
      while (cur <= end){
        const dow = DOW[cur.getDay()];  // "Mon", "Tue", ...
        const session = weekly[dow] || "Rest";
        const label = `ðŸ—“ï¸ ${formatDateLong(cur)} â€” ${session}`;

        if (/erg\s*\(ut2\)/i.test(session)){
          out += templateErgUT2(label);
        } else if (/erg\s*\(ut1\/?at\)/i.test(session)){
          out += templateErgUT1AT(label);
        } else if (/water row/i.test(session)){
          out += templateWaterRow(label);
        } else if (/weight/i.test(session)){
          out += templateWeights(label);
        } else {
          out += templateRest(label);
        }

        cur.setDate(cur.getDate() + 1);
      }

      out += buildSummary(meta);

      return out.trim() + "\n";
    }

    // ---------- MAIN BUTTON HANDLER ----------
    $("#generateBtn").addEventListener("click", ()=>{
      const src = $("#inputJson").value.trim();
      if (!src){
        toast("Paste JSON first", false);
        return;
      }
      let raw;
      try{
        raw = JSON.parse(src);
      }catch(e){
        toast("Invalid JSON: " + e.message, false);
        return;
      }

      try{
        const meta = normalisePayload(raw);
        if (!meta.program.start_date || !meta.program.end_date){
          throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
        }
        const diary = buildDiary(meta);
        $("#outputDiary").value = diary;
        toast("Diary generated âœ”");
      }catch(e){
        toast(e.message || "Error generating diary", false);
      }
    });
  </script>
</body>
</html>
