<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL — Program Text Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0f172a;
      --panel2:#020617;
      --text:#e5f0ff;
      --muted:#9fb5d1;
      --outline:#1e3a5f;
      --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:radial-gradient(circle at top,#0b1530 0,#020617 55%,#000 100%);
      color:var(--text);
      font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 10px; font-size:28px }

    .panel{
      background:var(--panel);
      border:1px solid var(--outline);
      border-radius:14px;
      padding:16px;
    }

    .layout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }

    @media (max-width:900px){
      .layout{ grid-template-columns:1fr }
    }

    label{ font-size:12px; color:var(--muted); margin:0 0 4px; display:block }

    textarea{
      width:100%;
      min-height:360px;
      resize:vertical;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--outline);
      border-radius:10px;
      padding:10px;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      outline:none;
    }
    textarea::placeholder{ color:#64748b }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--outline);
      background:rgba(15,23,42,.9);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.primary{
      background:linear-gradient(135deg,#0ea5e9,#2563eb);
      border-color:#2563eb;
      color:#e5f0ff;
    }
    .btn.ghost{ background:transparent; opacity:.9 }
    .btn:disabled{ opacity:.6; cursor:default }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .tiny{ font-size:12px; color:var(--muted); margin-top:8px }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#0f172a;
      border:1px solid var(--outline);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:50;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RowXL — Program Text Generator</h1>
    <div class="tiny">
      Paste the JSON you receive from the Program Builder on the left, then click
      <strong>Generate diary</strong>. A full day-by-day training diary will appear on the right for you to copy.
    </div>

    <div class="panel" style="margin-top:18px">
      <div class="layout">
        <!-- LEFT: JSON INPUT -->
        <div>
          <label for="inputJson">Program JSON</label>
          <textarea id="inputJson" spellcheck="false" placeholder='Paste JSON from Program Builder here...'></textarea>
          <div class="controls-row">
            <button id="loadSampleBtn" class="btn ghost" type="button">Load sample JSON</button>
            <button id="generateBtn" class="btn primary" type="button">Generate diary</button>
          </div>
        </div>

        <!-- RIGHT: DIARY OUTPUT -->
        <div>
          <label for="outputDiary">Generated Training Diary (copy &amp; paste)</label>
          <textarea id="outputDiary" spellcheck="false" placeholder="Your program diary will appear here..."></textarea>
          <div class="controls-row">
            <button id="copyDiaryBtn" class="btn ghost" type="button">Copy diary</button>
            <button id="clearBtn" class="btn ghost" type="button">Clear</button>
          </div>
          <div class="tiny">
            Every day will include: Warm-up, Main Set, Stroke Rate/HR zone (where relevant),
            Technical Focus, Notes, and an Athlete Notes section. A short summary will be added at the end.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = s => document.querySelector(s);
    const toast = (msg, ok=true)=>{
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      t.style.borderColor = ok ? "#16a34a" : "#b91c1c";
      clearTimeout(t._h);
      t._h = setTimeout(()=>{ t.style.display="none"; }, 2600);
    };

    // ---- SAMPLE JSON (matches what your Program Builder sends) ----
    const SAMPLE = JSON.stringify({
      "notes": "I’m doing a 1k test at the end of the program",
      "gender": "Male",
      "category": "Masters",
      "start_date": "2025-11-26",
      "finish_date": "2025-12-01",
      "athlete_name": "Noel Carey",
      "athlete_email": "noelcarey74@yahoo.ie",
      "weekly_schedule": {
        "Fri": "Water Row",
        "Mon": "Erg (UT2)",
        "Sat": "Weights",
        "Sun": "Erg (UT1/AT)",
        "Thu": "Water Row",
        "Tue": "Weights",
        "Wed": "Rest"
      },
      "intensity_percent": 75
    }, null, 2);

    $("#loadSampleBtn").addEventListener("click", ()=>{
      $("#inputJson").value = SAMPLE;
      toast("Sample JSON loaded");
    });

    $("#clearBtn").addEventListener("click", ()=>{
      $("#inputJson").value = "";
      $("#outputDiary").value = "";
    });

    $("#copyDiaryBtn").addEventListener("click", async ()=>{
      const text = $("#outputDiary").value;
      if (!text.trim()) { toast("Nothing to copy", false); return; }
      try{
        await navigator.clipboard.writeText(text);
        toast("Diary copied ✔");
      }catch(e){
        toast("Copy failed", false);
      }
    });

    // ---------- JSON NORMALISATION ----------
    function normalisePayload(raw){
      // Athlete block
      const athlete = raw.athlete ? {...raw.athlete} : {};
      if (!athlete.name && raw.athlete_name) athlete.name = raw.athlete_name;
      if (!athlete.email && raw.athlete_email) athlete.email = raw.athlete_email;
      if (!athlete.gender && raw.gender) athlete.gender = raw.gender;
      if (!athlete.category && raw.category) athlete.category = raw.category;

      // Program block (accept both nested + flat fields)
      const program = raw.program ? {...raw.program} : {};
      if (!program.start_date && raw.start_date) program.start_date = raw.start_date;
      if (!program.end_date && (raw.finish_date || raw.end_date)) {
        program.end_date = raw.finish_date || raw.end_date;
      }
      if (program.intensity_percent == null && raw.intensity_percent != null) {
        program.intensity_percent = raw.intensity_percent;
      }
      if (!program.weekly_schedule && raw.weekly_schedule) {
        program.weekly_schedule = raw.weekly_schedule;
      }
      if (!program.focus && raw.focus) program.focus = raw.focus;
      if (!program.notes && raw.notes) program.notes = raw.notes;

      const title = raw.title ||
        `${athlete.category || "Masters"}${athlete.gender ? " – " + athlete.gender : ""} Training Diary`.trim();
      const quote = raw.quote || "Consistency builds champions.";

      return { title, athlete, program, quote };
    }

    function parseISODate(str){
      const parts = String(str).split("-");
      if (parts.length !== 3) return null;
      const y = parseInt(parts[0],10);
      const m = parseInt(parts[1],10);
      const d = parseInt(parts[2],10);
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }

    function formatDateLong(d){
      return d.toLocaleDateString("en-GB", {
        weekday:"long",
        day:"numeric",
        month:"long",
        year:"numeric"
      });
    }

    function formatDateShort(d){
      return d.toISOString().slice(0,10);
    }

    const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const ALL_DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    // Global intensity for the current block (used by templates)
    let CURRENT_BLOCK_INTENSITY = 75;

    function describeIntensity(pct){
      const p = Number(pct || 0);
      if (p <= 30)  return "Very easy / recovery or rehab block";
      if (p <= 50)  return "Technical and light aerobic focus";
      if (p <= 70)  return "Steady aerobic development block";
      if (p <= 85)  return "Hard training block with threshold work";
      if (p <= 95)  return "Peak block with race-prep and test work";
      return "Very high intensity block – racing or key testing focus";
    }

    // ---------- INTRO ----------
    function buildIntro(meta){
      const { title, athlete, program, quote } = meta;
      const start = program.start_date;
      const end   = program.end_date;
      const cat   = athlete.category || "Masters";
      const gender = athlete.gender || "";
      const intensity = program.intensity_percent ?? 75;
      const focus = program.focus || "Aerobic base and technical consistency";

      const weekly = program.weekly_schedule || {};
      const weeklyLines = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(
        d=>`${d} ${weekly[d] || "Rest"}`
      );

      const intensityText = describeIntensity(intensity);

      return [
        `${title}`,
        `Dates: ${start} → ${end}`,
        `Category: ${cat}${gender ? " ("+gender+")" : ""}`,
        `Intensity Level: ~${intensity}%${intensityText ? " – " + intensityText : ""}`,
        `Primary Focus: ${focus}`,
        ``,
        `Weekly Structure:`,
        ...weeklyLines,
        ``,
        `Quote:`,
        `“${quote}”`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // ---------- DAY TEMPLATES ----------
    function templateRest(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `None planned.`,
        ``,
        `Main Set:`,
        `Rest day.`,
        ``,
        `Focus:`,
        `Recovery, sleep and general mobility.`,
        ``,
        `Notes:`,
        `Light walking or gentle stretching is encouraged, but no structured training is required.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Steady UT2 / UT1 water
    function templateWaterUT2(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10–15 minutes light paddling, building gradually from very easy to steady rowing.`,
        `Include 3 × 10 stroke builds up to 22–24 spm with plenty of paddling between.`,
        ``,
        `Main Set:`,
        `Option A – continuous:`,
        `• 40–50 minutes steady rowing.`,
        ``,
        `Option B – broken:`,
        `• 2 × 20–25 minutes with 3 minutes light paddling between pieces.`,
        `Stroke Rate: 18–22 spm`,
        `Heart Rate: UT2 to light UT1 (roughly 60–75% HR max).`,
        ``,
        `Technical Focus:`,
        `• Clean, quiet catches with the blade fully loaded before the drive.`,
        `• Strong leg drive while the upper body stays relaxed and supported.`,
        `• Level hands at the finish and tidy, consistent tap-down.`,
        ``,
        `Focus:`,
        `Boat run, timing and aerobic efficiency with no rush on the slide.`,
        ``,
        `Notes:`,
        `If conditions are poor, shorten the main set slightly but keep it controlled and safe. Prioritise timing and balance over power.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // AT / race-prep water (high rate, harder work)
    function templateWaterAT(label, athlete){
      const genderRaw = (athlete && athlete.gender) ? String(athlete.gender).toLowerCase() : "";
      const isFemale =
        genderRaw.includes("female") ||
        genderRaw.includes("woman")  ||
        genderRaw.includes("women")  ||
        genderRaw.includes("girl");

      const rateLine = isFemale
        ? "Stroke Rate: 30–32 spm (Masters women AT)"
        : "Stroke Rate: 32–34 spm (Masters men AT)";

      const options = [];

      // Set A – 6 × 500 m
      options.push([
        `Set A – 6 × 500 m @ AT:`,
        `• 6 × 500 m at strong but sustainable race pressure.`,
        `• ${rateLine}.`,
        `• Rest: 3 minutes light paddling between pieces.`,
        ``,
        `Focus for this set:`,
        `• Commit to the leg drive from the first stroke.`,
        `• Maintain length – do not shorten as you fatigue.`,
        `• Keep blades clean on the entry and quiet on the release.`
      ]);

      // Set B – 3 × 750 m
      options.push([
        `Set B – 3 × 750 m @ AT:`,
        `• 3 × 750 m pieces building from strong base pace into finishing pace in the last 10–15 strokes.`,
        `• ${rateLine}.`,
        `• Rest: 3–4 minutes very light paddling between pieces.`,
        ``,
        `Focus for this set:`,
        `• Rhythm in the middle of the piece – no rushing on the slide.`,
        `• Keep the crew connected through the drive and finishes.`,
        `• Think “relaxed top half, ruthless legs”.`
      ]);

      // Set C – 2 × (4 × 250 m) with race starts
      options.push([
        `Set C – 2 × (4 × 250 m) with race starts:`,
        `• 2 blocks of 4 × 250 m.`,
        `• First 10–15 strokes of each 250 m as race start + build, then settle to AT rhythm.`,
        `• ${rateLine}.`,
        `• Rest: 90 seconds between 250 m pieces, 4–5 minutes easy paddling between the two blocks.`,
        ``,
        `Focus for this set:`,
        `• Crisp, disciplined start sequence (no yanking).`,
        `• Quick catches with the boat moving, not stopped.`,
        `• Hold posture and length even as the rate comes up.`
      ]);

      const chosen = options[Math.floor(Math.random()*options.length)];

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `15–20 minutes building from very light paddling up to firm strokes.`,
        `Include:`,
        `• 3 × 10–12 stroke bursts up to AT stroke rate with plenty of easy paddling between.`,
        `• A few practice starts over 10–15 strokes.`,
        ``,
        `Main Set:`,
        ...chosen,
        ``,
        `Heart Rate:`,
        `• Roughly 80–90% HR max (you should feel challenged but still technical).`,
        ``,
        `Technical Focus:`,
        `• Sequencing: legs, then body, then arms – even when pressure and rate are high.`,
        `• Stable platform through the feet and core so the hull stays level.`,
        `• Clean finishes with quick tap-down and direct hands into the recovery.`,
        ``,
        `Notes:`,
        `This is a key AT / race-prep session. Quality matters more than volume – if technique breaks down, reduce the number of pieces rather than chasing more metres.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Technique / drills water session
    function templateTechniqueDrills(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10–15 minutes light paddling with rating 18–20 spm, focusing on quiet hands and simple rhythm.`,
        ``,
        `Main Set (choose 3–4 drills):`,
        `• Pick drill: arms only → arms & body → half slide → full slide (3–5 minutes each).`,
        `• Paused rowing at 1/4 and 1/2 slide to feel posture and connection (3 × 3 minutes).`,
        `• Square-blade rowing on the feather side to sharpen catches and finishes (2 × 6–8 minutes).`,
        `• Outside-arm-only rowing to feel suspension and drive through the legs (2 × 4 minutes).`,
        `• Rate-building pieces: 3 × 4 minutes at 20–22 spm, focusing on length and balance.`,
        ``,
        `Technical Focus:`,
        `• Tall posture, weight on the feet, loose shoulders.`,
        `• Blade placement: quick and clean into the water with no skying.`,
        `• Consistent hand heights through the drive and release.`,
        ``,
        `Focus:`,
        `Pure technique. Pressure stays light to moderate so that the crew can make technical changes without fatigue.`,
        ``,
        `Notes:`,
        `If the block intensity is high (~${CURRENT_BLOCK_INTENSITY}%), keep this session low pressure so it supports the harder work on other days.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateWeights(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5–8 minutes light cardio (row, cycle or treadmill) plus dynamic mobility for hips, hamstrings, shoulders and back.`,
        ``,
        `Main Set (rowing-specific strength):`,
        `Block A`,
        `• Goblet Squat – 3 × 10`,
        `• Romanian Deadlift – 3 × 8`,
        ``,
        `Block B`,
        `• Lat Pulldown or Assisted Pull-down – 3 × 10`,
        `• Dumbbell Bench Press – 3 × 8`,
        ``,
        `Block C`,
        `• Seated or Cable Row – 3 × 10`,
        `• Front Plank – 3 × 30–40 seconds`,
        ``,
        `Rest:`,
        `60–90 seconds between working sets.`,
        ``,
        `Technical Focus:`,
        `• Neutral spine at all times (no rounding).`,
        `• Drive from the legs and hips rather than the lower back.`,
        `• Smooth, controlled lowering phase; strong but not jerky on the way up.`,
        ``,
        `Focus:`,
        `Maintain rowing-specific strength and robustness without creating heavy fatigue – this is not bodybuilding.`,
        ``,
        `Notes:`,
        `Choose loads that feel “comfortably hard” on the last 2 reps but always leave 1–2 good reps in reserve, especially in a higher-intensity block (~${CURRENT_BLOCK_INTENSITY}%).`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Circuit / HIIT (bodyweight + light load)
    function templateCircuitHIIT(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let work, rest, rounds;
      if (i <= 50){
        work = "30 seconds work"; rest = "30–40 seconds rest"; rounds = "2–3";
      } else if (i <= 75){
        work = "30–40 seconds work"; rest = "20–30 seconds rest"; rounds = "3–4";
      } else {
        work = "40 seconds work"; rest = "20 seconds rest"; rounds = "4";
      }
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `8–10 minutes light cardio and dynamic mobility (hips, ankles, shoulders, trunk).`,
        ``,
        `Main Set (Rowing Conditioning Circuit):`,
        `${rounds} rounds of:`,
        `• Goblet Squat or Bodyweight Squat — ${work}`,
        `• Push-up or Incline Push-up — ${work}`,
        `• Kettlebell Swing or Hip Hinge — ${work}`,
        `• Inverted Row / Band Row — ${work}`,
        `• Plank Variations (front / side) — ${work}`,
        `• Light erg, bike or skipping — ${work}`,
        `Rest between exercises: ${rest}.`,
        ``,
        `Technical Focus:`,
        `• Quality of movement first, speed second.`,
        `• Strong midline (rib cage over hips, no excessive arching).`,
        `• Land soft on impact exercises; protect knees and lower back.`,
        ``,
        `Focus:`,
        `General conditioning for rowing, respecting the overall block intensity (~${i}%) so that it supports, not replaces, your key rowing sessions.`,
        ``,
        `Notes:`,
        `If fatigue is high or the block is very intense, drop one round and keep movements crisp rather than grinding.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateCore(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5 minutes light movement (walk, bike or easy erg) plus a few gentle spine flexion/extension and rotation movements.`,
        ``,
        `Main Set (Core for Rowers):`,
        `• Front Plank – 3 × 30–45 seconds.`,
        `• Side Plank (left + right) – 3 × 20–30 seconds each side.`,
        `• Dead Bug or Hollow Hold – 3 × 8–10 controlled reps per side.`,
        `• Bird Dog – 3 × 8–10 controlled reps per side.`,
        `• Glute Bridge or Hip Thrust – 3 × 12–15 reps.`,
        ``,
        `Technical Focus:`,
        `• Ribs stacked over pelvis, no excessive arching of the lower back.`,
        `• Smooth breathing; do not hold your breath.`,
        `• Slow, deliberate control rather than speed.`,
        ``,
        `Focus:`,
        `Build trunk stability to support power transfer in the boat and on the erg, especially important for Masters athletes.`,
        ``,
        `Notes:`,
        `Intensity dial: higher block intensity (~${CURRENT_BLOCK_INTENSITY}%) means core work stays tidy and controlled, not maximal; save your energy for rowing and key sessions.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // UT2 erg now depends on gender (2×20 women, 2×30 men)
    function templateErgUT2(label, athlete){
      const genderRaw = (athlete && athlete.gender) ? String(athlete.gender).toLowerCase() : "";
      const isFemale =
        genderRaw.includes("female") ||
        genderRaw.includes("woman")  ||
        genderRaw.includes("women")  ||
        genderRaw.includes("girl");

      const mainSetLine = isFemale
        ? `2 × 20 minutes continuous UT2 rowing.`
        : `2 × 30 minutes continuous UT2 rowing.`;

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes very easy rowing, gradually building from light paddling to a steady UT2 rhythm.`,
        ``,
        `Main Set:`,
        mainSetLine,
        `Stroke Rate: 18–20 spm`,
        `Heart Rate: 60–70% HR max (easy conversational effort).`,
        `Rest: 3 minutes very light paddling between pieces.`,
        ``,
        `Technical Focus:`,
        `• Long, relaxed stroke with quiet shoulders.`,
        `• Strong connection through the legs before the body and arms.`,
        `• Smooth, unhurried recovery with balanced posture on the slide.`,
        ``,
        `Focus:`,
        `Aerobic conditioning and rhythm at approximately 75% effort, without chasing split.`,
        ``,
        `Notes:`,
        `Even in a higher-intensity block (~${CURRENT_BLOCK_INTENSITY}%), UT2 should feel controlled and sustainable — you finish each piece knowing you could continue.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateErgUT1AT(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes light rowing, gradually building from UT2 into the lower end of UT1 (20–22 spm).`,
        ``,
        `Main Set:`,
        `3 × 8–10 minutes at UT1 / AT (comfortably hard).`,
        `Stroke Rate: 22–26 spm.`,
        `Rest: 3–4 minutes very light paddling between pieces.`,
        ``,
        `Technical Focus:`,
        `• Powerful but relaxed leg drive; stay tall through the trunk.`,
        `• Keep the handle speed smooth into and away from the body.`,
        `• No rushing on the slide, even when the rate is high.`,
        ``,
        `Focus:`,
        `Build threshold fitness while keeping the stroke long and tidy.`,
        ``,
        `Notes:`,
        `You should feel challenged but in control. In a very hard block (~${CURRENT_BLOCK_INTENSITY}%), use the shorter end of the duration range and keep technique sharp.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Erg intervals (shorter pieces)
    function templateErgIntervals(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let blockDesc;
      let setLines;

      if (i <= 55){
        blockDesc = "Controlled interval work to support aerobic development without excessive stress.";
        setLines = [
          `Main Set:`,
          `• 2 × 10 minutes as (8 × 45 seconds on / 45 seconds off) at firm pressure.`,
          `• Stroke Rate: 22–24 spm.`,
          `• On segments: strong but not maximal; off segments: very light paddling.`,
          `Rest: 4 minutes light rowing between the two 10-minute blocks.`
        ];
      } else if (i <= 80){
        blockDesc = "Stronger interval work that bridges UT1 and AT, good preparation for tests and racing.";
        setLines = [
          `Main Set:`,
          `• 3 × 8 minutes as (6 × 50 seconds on / 30 seconds off).`,
          `• Stroke Rate: 24–26 spm.`,
          `• On segments: just above 2k–5k pace feel; off segments: light but moving.`,
          `Rest: 4 minutes very light rowing between blocks.`
        ];
      } else {
        blockDesc = "High-intensity interval work. This is serious training and should be placed carefully in the week.";
        setLines = [
          `Main Set:`,
          `• 3 × 6 minutes at AT as (12 × 20 seconds on / 10 seconds off).`,
          `• Stroke Rate: 26–28 spm.`,
          `• On segments: close to 2k power; off segments: keep moving, but just enough to clear.`,
          `Rest: 5 minutes very light rowing between blocks.`
        ];
      }

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `12–15 minutes building from light paddling to strong strokes, including 3 × 10 stroke bursts up to 24–26 spm.`,
        ``,
        ...setLines,
        ``,
        `Technical Focus:`,
        `• Same stroke shape at low and high rate.`,
        `• Hang off the handle with strong legs; avoid over-pulling with the arms.`,
        `• Stay loose in the shoulders and jaw as effort increases.`,
        ``,
        `Focus:`,
        blockDesc,
        ``,
        `Notes:`,
        `Match the overall block intensity (~${i}%) — if you are carrying fatigue, trim 1 block or reduce rate slightly rather than forcing it.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Bike cross-training
    function templateBike(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let mainLines;

      if (i <= 50){
        mainLines = [
          `Main Set:`,
          `• 35–45 minutes continuous riding at comfortable pace.`,
          `• Cadence: 85–95 rpm.`,
          `• You should be able to talk in full sentences (easy–steady).`
        ];
      } else if (i <= 80){
        mainLines = [
          `Main Set:`,
          `• 2 × 15 minutes steady riding with 5 minutes easy spin between.`,
          `• Within each 15 minutes, include 4 × 30 seconds at firmer pressure with 90 seconds easy.`,
          `• Cadence: 85–95 rpm throughout.`
        ];
      } else {
        mainLines = [
          `Main Set:`,
          `• 3 × 8 minutes at firm, controlled effort.`,
          `• Within each 8 minutes, alternate 1 minute strong / 1 minute steady.`,
          `• 4–5 minutes very easy pedalling between blocks.`,
          `• Cadence: 90+ rpm, avoid grinding big gears.`
        ];
      }

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes easy spin, gradually lifting cadence, plus a few short 10–15 second pickups.`,
        ``,
        ...mainLines,
        ``,
        `Technical Focus:`,
        `• Smooth circles through the pedals rather than stamping.`,
        `• Relax the upper body and keep hands light on the bars.`,
        `• Maintain posture similar to rowing: tall through the torso, not slumped.`,
        ``,
        `Focus:`,
        `Support rowing fitness without beating up the joints — cycling should leave you fresher for water and erg work, especially at intensity ~${i}%.`,
        ``,
        `Notes:`,
        `If you feel any knee or hip discomfort, reduce gear and focus on cadence and smoothness rather than power.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Run cross-training
    function templateRun(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let mainLines;

      if (i <= 50){
        mainLines = [
          `Main Set:`,
          `• 25–35 minutes easy jog or walk/jog mix.`,
          `• You should always be able to talk in full sentences.`,
          `• Use soft surfaces where possible (grass, track, trail).`
        ];
      } else if (i <= 80){
        mainLines = [
          `Main Set:`,
          `• 10 minutes easy jog, then:`,
          `• 6 × 2 minutes at steady effort / 2 minutes easy jog or walk.`,
          `• Finish with 5–10 minutes easy jog or brisk walk.`
        ];
      } else {
        mainLines = [
          `Main Set:`,
          `• 15 minutes easy jog, then:`,
          `• 8 × 60 seconds strong / 90 seconds walk or easy jog.`,
          `• Finish with 8–10 minutes easy jog or walk to cool down.`,
          `• Keep impact sensible – this is support work for rowing, not a running race.`
        ];
      }

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5–10 minutes brisk walk or very easy jog, plus a few light mobility drills for ankles, knees and hips.`,
        ``,
        ...mainLines,
        ``,
        `Technical Focus:`,
        `• Soft, quiet foot strikes under your centre of mass.`,
        `• Upright posture, eyes forward, relaxed arms swinging naturally.`,
        ``,
        `Focus:`,
        `General aerobic conditioning and bone health. Respect that your main sport is rowing — adjust volume as needed when the block intensity is ~${i}%.`,
        ``,
        `Notes:`,
        `If you have any history of lower-limb injury, keep this session shorter and easier, and prioritise off-feet options (bike, swim, SkiErg) when in doubt.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Swim cross-training
    function templateSwim(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let mainLines;

      if (i <= 50){
        mainLines = [
          `Main Set:`,
          `• 800–1200 m continuous easy swimming, mixing strokes as comfortable.`,
          `• Every 3rd length, think about long, relaxed strokes and steady breathing.`
        ];
      } else if (i <= 80){
        mainLines = [
          `Main Set:`,
          `• 3 × 8 minutes as: 2 minutes strong freestyle / 2 minutes easy drill or backstroke.`,
          `• 2–3 minutes easy between blocks.`,
          `• Total distance roughly 1200–1600 m, depending on pace.`
        ];
      } else {
        mainLines = [
          `Main Set:`,
          `• 12 × 50 m freestyle @ strong but controlled pace.`,
          `• Rest: 20–30 seconds between 50s.`,
          `• Then 400–600 m easy mixed swim to cool down.`
        ];
      }

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `200–400 m very easy mixed strokes and drills.`,
        ``,
        ...mainLines,
        ``,
        `Technical Focus:`,
        `• Long strokes with good body position (hips high in the water).`,
        `• Calm, regular breathing.`,
        ``,
        `Focus:`,
        `Low-impact aerobic conditioning and shoulder health to complement rowing, particularly valuable when the block intensity is ~${i}% and legs are tired.`,
        ``,
        `Notes:`,
        `If you are not a confident swimmer, stay well within your comfort zone and favour easy, continuous swimming over any hard efforts.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // SkiErg
    function templateSkiErg(label){
      const i = CURRENT_BLOCK_INTENSITY;
      let mainLines;

      if (i <= 55){
        mainLines = [
          `Main Set:`,
          `• 3 × 8 minutes continuous SkiErg at steady aerobic effort.`,
          `• Rest: 2–3 minutes easy between blocks.`
        ];
      } else if (i <= 80){
        mainLines = [
          `Main Set:`,
          `• 4 × 6 minutes at firm effort.`,
          `• Within each 6 minutes: 40 seconds strong / 20 seconds light.`,
          `• Rest: 3 minutes easy between blocks.`
        ];
      } else {
        mainLines = [
          `Main Set:`,
          `• 3 × 8 minutes as: 30 seconds strong / 30 seconds light continuous.`,
          `• Stroke Rate: allow natural rhythm but keep movements crisp.`,
          `• Rest: 4 minutes easy between blocks.`
        ];
      }

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes easy SkiErg, gradually building length and pressure.`,
        ``,
        ...mainLines,
        ``,
        `Technical Focus:`,
        `• Drive from hips and trunk, not just arms.`,
        `• Maintain neutral spine; no excessive rounding at the bottom.`,
        ``,
        `Focus:`,
        `Upper-body dominant conditioning that carries over to rowing finishes and trunk control, adjusted for the overall block intensity (~${i}%).`,
        ``,
        `Notes:`,
        `Dial down volume if you feel excessive upper-back or shoulder fatigue; this should support, not replace, rowing work.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Recovery & mobility disciplines
    function templateYoga(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `A few minutes of quiet breathing and very gentle joint circles (neck, shoulders, hips).`,
        ``,
        `Main Set:`,
        `• 20–40 minutes of gentle yoga or guided flow, focusing on hips, hamstrings, thoracic spine and shoulders.`,
        `• Move within comfortable ranges; no forcing of positions.`,
        ``,
        `Technical Focus:`,
        `• Smooth, unhurried breathing – exhale into stretches.`,
        `• Keep all sensations in the “comfortable stretch” zone, not sharp pain.`,
        ``,
        `Focus:`,
        `Restore movement and down-regulate the nervous system so you can absorb the harder training days, especially in higher-intensity blocks.`,
        ``,
        `Notes:`,
        `Even if your program intensity is ~${CURRENT_BLOCK_INTENSITY}%, treat this as a low-stress recovery tool – not a workout.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templatePilates(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5 minutes of easy mobility (cat–camel, hip circles, shoulder rolls).`,
        ``,
        `Main Set:`,
        `• 20–40 minutes of Pilates-based core and control work (mat or reformer).`,
        `• Emphasis on trunk stability, hip control and breathing.`,
        ``,
        `Technical Focus:`,
        `• Controlled, precise movements with steady breathing.`,
        `• Think “quality over quantity” – stop well before fatigue breaks form.`,
        ``,
        `Focus:`,
        `Improve body awareness and control to support technical changes in the boat and on the erg.`,
        ``,
        `Notes:`,
        `Keep intensity low to moderate regardless of the block (~${CURRENT_BLOCK_INTENSITY}%). This is about control, not exhaustion.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateMobility(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `A few minutes of easy walking or light cycling to raise temperature slightly.`,
        ``,
        `Main Set (20–30 minutes):`,
        `• Ankles: calf raises, ankle circles and gentle dorsiflexion stretches.`,
        `• Hips: lunges, hip flexor stretches, deep squat holds with support.`,
        `• Thoracic spine: open-book rotations, wall slides, gentle twists.`,
        `• Shoulders: band pull-aparts, doorway stretch, overhead reach.`,
        ``,
        `Technical Focus:`,
        `• Move slowly in and out of stretches; avoid bouncing.`,
        `• Breathe normally; each exhale allows you to relax deeper.`,
        ``,
        `Focus:`,
        `Maintain the ranges of motion needed for a long rowing stroke and comfortable catch position.`,
        ``,
        `Notes:`,
        `This is always low intensity, even in a high-intensity block (~${CURRENT_BLOCK_INTENSITY}%). Use it to feel better, not more tired.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateActiveRecovery(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `Start with 5–10 minutes of easy movement (walk, very easy bike or erg).`,
        ``,
        `Main Set:`,
        `• 20–30 minutes of very light activity – e.g. easy cycle, walk, or technical paddling only.`,
        `• Effort stays at or below 60% HR max (pure conversational pace).`,
        ``,
        `Technical Focus:`,
        `• Relax, breathe and let the body move freely.`,
        ``,
        `Focus:`,
        `Promote blood flow and recovery while keeping overall stress very low, especially important when the block is set around ${CURRENT_BLOCK_INTENSITY}%.`,
        ``,
        `Notes:`,
        `If you feel more tired at the end than at the start, you went too hard – back off next time.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templatePhysioRehab(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `Follow the guidance from your physio or medical professional – usually a few minutes of very gentle movement.`,
        ``,
        `Main Set:`,
        `• Complete your prescribed rehab exercises exactly as instructed (sets, reps, tempo).`,
        `• Avoid adding extra weight or volume beyond the plan.`,
        ``,
        `Technical Focus:`,
        `• Slow, controlled movement in the pain-free range.`,
        `• Stop if you feel sharp pain, giving way, or anything that feels unsafe.`,
        ``,
        `Focus:`,
        `Return to full training safely. The priority is tissue healing and long-term performance, not short-term fitness.`,
        ``,
        `Notes:`,
        `Block intensity (~${CURRENT_BLOCK_INTENSITY}%) is less important here — rehab rules always win. If rehab is on the plan, other sessions may need to be lighter.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // Test sessions
    function templateTest(label, distance){
      const i = CURRENT_BLOCK_INTENSITY;
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `20–25 minutes total:`,
        `• 10 minutes easy rowing building to UT1.`,
        `• 3 × 2 minutes at just below test pace / 2 minutes light.`,
        `• A few short bursts (10–15 strokes) at or slightly above test pace.`,
        ``,
        `Main Set:`,
        `• ${distance} test on the erg or water (depending on your setup).`,
        `• Aim for even or slightly negative split – finish strongest.`,
        ``,
        `Technical Focus:`,
        `• Settle quickly into your race rhythm.`,
        `• Long, connected strokes even as you fatigue.`,
        `• Keep breathing organised; relax face and shoulders.`,
        ``,
        `Focus:`,
        `Benchmark performance for this block (~${i}% intensity) and gather data for future pacing and planning.`,
        ``,
        `Notes:`,
        `Treat this as a key day. If you feel very flat, consider moving the test by a day rather than forcing a poor result.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateRaceRegatta(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `Follow your agreed race warm-up for the event (typically 20–30 minutes total including builds and a few race-pace bursts).`,
        ``,
        `Main Set:`,
        `• Race pieces as per the regatta schedule.`,
        ``,
        `Technical Focus:`,
        `• Execute the race plan you have practised in training.`,
        `• Stay composed off the start; length and rhythm first, then pressure.`,
        ``,
        `Focus:`,
        `Deliver your best possible performance today, using the work from this training block (~${CURRENT_BLOCK_INTENSITY}%).`,
        ``,
        `Notes:`,
        `Between races, prioritise hydration, light food and gentle movement. Avoid any extra “training” today – racing is the training.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateOffTravel(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `None planned – this is primarily a non-training day.`,
        ``,
        `Main Set:`,
        `Off / travel day – no formal training required.`,
        ``,
        `Focus:`,
        `Arrive rested, hydrated and ready for the next training or racing days.`,
        ``,
        `Notes:`,
        `On long journeys, try to stand, walk and gently stretch every 60–90 minutes to keep blood flowing. Keep fluids up and avoid arriving overly stiff.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    // ---------- SUMMARY AT END ----------
    function buildSummary(meta){
      const { athlete, program } = meta;
      const start = parseISODate(program.start_date);
      const end   = parseISODate(program.end_date);
      if (!start || !end) return "";

      const days = Math.round((end - start) / (1000*60*60*24)) + 1;
      const weekly = program.weekly_schedule || {};
      const focus  = program.focus || "Aerobic base and technical consistency";
      const intensity = program.intensity_percent ?? 75;
      const notesRaw = String(program.notes || "").trim();

      const weeklyLine = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
        .map(d => `${d}: ${weekly[d] || "Rest"}`)
        .join("; ");

      const summaryLines = [
        `End-of-Block Summary`,
        ``,
        `• Duration: ${days} day(s) from ${program.start_date} to ${program.end_date}.`,
        `• Athlete: ${athlete.name || "—"} (${athlete.category || "Masters"}${athlete.gender ? ", " + athlete.gender : ""}).`,
        `• Focus: ${focus}.`,
        `• Planned intensity: around ${intensity}%.`,
        `• Weekly pattern: ${weeklyLine}.`
      ];

      // ---- Intelligent handling of notes ----
      if (notesRaw){
        const notes = notesRaw;
        const lower = notes.toLowerCase();

        const shortNote = notes.length > 160 ? notes.slice(0,157) + "…" : notes;

        const hasTest =
          lower.includes("1k") || lower.includes("2k") || lower.includes("5k") ||
          lower.includes("test") || lower.includes("time trial") || lower.includes("tt");

        const hasRace =
          lower.includes("regatta") || lower.includes("head") || lower.includes("horr") ||
          lower.includes("race") || lower.includes("championship") ||
          lower.includes("wrmr") || lower.includes("worlds") ||
          lower.includes("henley") || lower.includes("irish champs");

        const hasInjury =
          lower.includes("injury") || lower.includes("injured") ||
          lower.includes("back") || lower.includes("shoulder") ||
          lower.includes("knee") || lower.includes("hip") ||
          lower.includes("rib") || lower.includes("ribs") ||
          lower.includes("wrist") || lower.includes("elbow") ||
          lower.includes("neck") || lower.includes("tendon") ||
          lower.includes("strain") || lower.includes("sprain") ||
          lower.includes("tear") || lower.includes("pulled") ||
          lower.includes("surgery") || lower.includes("operation") ||
          lower.includes("ill") || lower.includes("sick") ||
          lower.includes("flu") || lower.includes("covid");

        const hasScheduleIssue =
          lower.includes("holiday") || lower.includes("vacation") ||
          lower.includes("travel") || lower.includes("away") ||
          lower.includes("work") || lower.includes("shift") ||
          lower.includes("on call") || lower.includes("busy") ||
          lower.includes("kids") || lower.includes("children") ||
          lower.includes("school") || lower.includes("exam") ||
          lower.includes("exams") || lower.includes("wedding");

        if (hasTest){
          summaryLines.push(
            `• Athlete note (test): ${shortNote}`,
            `• Coach attention: A performance test is planned near the end of this block. Use the hard erg and water sessions to rehearse pacing and race rhythm.`
          );
        }

        if (hasRace){
          summaryLines.push(
            `• Athlete note (race/regatta): ${shortNote}`,
            `• Coach attention: Upcoming racing is mentioned. In the final few sessions, prioritise good execution, rest and confidence over adding extra volume.`
          );
        }

        if (hasInjury){
          summaryLines.push(
            `• Athlete note (injury/illness): ${shortNote}`,
            `• Coach attention: Possible injury or illness flagged. Consider reducing load, extending warm-ups and monitoring symptoms closely.`
          );
        }

        if (hasScheduleIssue){
          summaryLines.push(
            `• Athlete note (schedule): ${shortNote}`,
            `• Coach attention: There may be constraints on training time in this block. Be flexible with session order and protect the key quality days.`
          );
        }

        if (!hasTest && !hasRace && !hasInjury && !hasScheduleIssue){
          summaryLines.push(`• Athlete note: ${shortNote}`);
        }
      }

      summaryLines.push(
  ``,
  `Coach tip: Review how each key session felt (on the water, on the erg, in the gym or in cross-training) and adjust the next block based on how well you handled this load.`,
  ``,
  `------------------------------------------------------------`
);

      return "\n" + summaryLines.join("\n") + "\n";
    }

    // ---------- DIARY BUILDER ----------
    function buildDiary(meta){
      const { program, athlete } = meta;
      let start = parseISODate(program.start_date);
      let end   = parseISODate(program.end_date);

      if (!start || !end) {
        throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
      }

      // Set global intensity for templates
      CURRENT_BLOCK_INTENSITY = typeof program.intensity_percent === "number"
        ? program.intensity_percent
        : 75;

      // ✅ Auto-fix if dates are reversed (finish before start)
      if (end < start){
        const tmpDate = start;
        start = end;
        end = tmpDate;

        const tmpStr = program.start_date;
        program.start_date = program.end_date;
        program.end_date = tmpStr;
      }

      const weekly = program.weekly_schedule || {};
      let out = buildIntro(meta);

      // Figure out which days of week are Water Rows
      const waterDOWs = ALL_DAYS.filter(d => {
        const s = weekly[d];
        return s && /water row/i.test(s);
      });

      const cur = new Date(start.getTime());
      while (cur <= end){
        const dow = DOW[cur.getDay()];  // "Mon", "Tue", ...
        const session = weekly[dow] || "Rest";
        const label = `🗓️ ${formatDateLong(cur)} — ${session}`;

        if (/erg\s*\(ut2\)/i.test(session)){
          out += templateErgUT2(label, athlete);
        } else if (/erg\s*\(ut1\/?at\)/i.test(session)){
          out += templateErgUT1AT(label);
        } else if (/erg\s*intervals/i.test(session)){
          out += templateErgIntervals(label);
        } else if (/water row/i.test(session)){
          if (waterDOWs.length >= 2) {
            const idx = waterDOWs.indexOf(dow);
            // First water session of the week = steady UT2,
            // second (and others) = AT water.
            if (idx === 0){
              out += templateWaterUT2(label);
            } else {
              out += templateWaterAT(label, athlete);
            }
          } else {
            out += templateWaterUT2(label);
          }
        } else if (/technique\/drills/i.test(session)){
          out += templateTechniqueDrills(label);
        } else if (/circuit\s*\/\s*hiit/i.test(session)){
          out += templateCircuitHIIT(label);
        } else if (/core\b/i.test(session)){
          out += templateCore(label);
        } else if (/bike/i.test(session)){
          out += templateBike(label);
        } else if (/run\b/i.test(session)){
          out += templateRun(label);
        } else if (/swim/i.test(session)){
          out += templateSwim(label);
        } else if (/skierg/i.test(session)){
          out += templateSkiErg(label);
        } else if (/yoga/i.test(session)){
          out += templateYoga(label);
        } else if (/pilates/i.test(session)){
          out += templatePilates(label);
        } else if (/mobility\s*\/\s*stretch/i.test(session)){
          out += templateMobility(label);
        } else if (/active recovery/i.test(session)){
          out += templateActiveRecovery(label);
        } else if (/physio\s*\/\s*rehab/i.test(session)){
          out += templatePhysioRehab(label);
        } else if (/test[^0-9]*1k/i.test(session)){
          out += templateTest(label, "1k");
        } else if (/test[^0-9]*2k/i.test(session)){
          out += templateTest(label, "2k");
        } else if (/test[^0-9]*5k/i.test(session)){
          out += templateTest(label, "5k");
        } else if (/test[^0-9]*6k/i.test(session)){
          out += templateTest(label, "6k");
        } else if (/race\s*\/\s*regatta/i.test(session)){
          out += templateRaceRegatta(label);
        } else if (/off\s*\/\s*travel/i.test(session)){
          out += templateOffTravel(label);
        } else if (/weight/i.test(session)){
          out += templateWeights(label);
        } else {
          out += templateRest(label);
        }

        cur.setDate(cur.getDate() + 1);
      }

      out += buildSummary(meta);

      return out.trim() + "\n";
    }

    // ---------- MAIN BUTTON HANDLER ----------
    $("#generateBtn").addEventListener("click", ()=>{
      const src = $("#inputJson").value.trim();
      if (!src){
        toast("Paste JSON first", false);
        return;
      }
      let raw;
      try{
        raw = JSON.parse(src);
      }catch(e){
        toast("Invalid JSON: " + e.message, false);
        return;
      }

      try{
        const meta = normalisePayload(raw);
        if (!meta.program.start_date || !meta.program.end_date){
          throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
        }
        const diary = buildDiary(meta);
        $("#outputDiary").value = diary;
        toast("Diary generated ✔");
      }catch(e){
        toast(e.message || "Error generating diary", false);
      }
    });
  </script>
</body>
</html>
