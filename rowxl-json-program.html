<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RowXL ‚Äî Program Text Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0f172a;
      --panel2:#020617;
      --text:#e5f0ff;
      --muted:#9fb5d1;
      --outline:#1e3a5f;
      --brand:#0e3a73;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:radial-gradient(circle at top,#0b1530 0,#020617 55%,#000 100%);
      color:var(--text);
      font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 20px }
    h1{ margin:0 0 10px; font-size:28px }

    .panel{
      background:var(--panel);
      border:1px solid var(--outline);
      border-radius:14px;
      padding:16px;
    }

    .layout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }

    @media (max-width:900px){
      .layout{ grid-template-columns:1fr }
    }

    label{ font-size:12px; color:var(--muted); margin:0 0 4px; display:block }

    textarea{
      width:100%;
      min-height:360px;
      resize:vertical;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--outline);
      border-radius:10px;
      padding:10px;
      font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      outline:none;
    }
    textarea::placeholder{ color:#64748b }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--outline);
      background:rgba(15,23,42,.9);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.primary{
      background:linear-gradient(135deg,#0ea5e9,#2563eb);
      border-color:#2563eb;
      color:#e5f0ff;
    }
    .btn.ghost{ background:transparent; opacity:.9 }
    .btn:disabled{ opacity:.6; cursor:default }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .tiny{ font-size:12px; color:var(--muted); margin-top:8px }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#0f172a;
      border:1px solid var(--outline);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:50;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RowXL ‚Äî Program Text Generator</h1>
    <div class="tiny">
      Paste the JSON you receive from the Program Builder on the left, then click
      <strong>Generate diary</strong>. A full day-by-day training diary will appear on the right for you to copy.
    </div>

    <div class="panel" style="margin-top:18px">
      <div class="layout">
        <!-- LEFT: JSON INPUT -->
        <div>
          <label for="inputJson">Program JSON</label>
          <textarea id="inputJson" spellcheck="false" placeholder='Paste JSON from Program Builder here...'></textarea>
          <div class="controls-row">
            <button id="loadSampleBtn" class="btn ghost" type="button">Load sample JSON</button>
            <button id="generateBtn" class="btn primary" type="button">Generate diary</button>
          </div>
        </div>

        <!-- RIGHT: DIARY OUTPUT -->
        <div>
          <label for="outputDiary">Generated Training Diary (copy &amp; paste)</label>
          <textarea id="outputDiary" spellcheck="false" placeholder="Your program diary will appear here..."></textarea>
          <div class="controls-row">
            <button id="copyDiaryBtn" class="btn ghost" type="button">Copy diary</button>
            <button id="clearBtn" class="btn ghost" type="button">Clear</button>
          </div>
          <div class="tiny">
            Every day will include: Warm-up, Main Set, Stroke Rate/HR zone (where relevant),
            Technical Focus, Notes, and an Athlete Notes section.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = s => document.querySelector(s);
    const toast = (msg, ok=true)=>{
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      t.style.borderColor = ok ? "#16a34a" : "#b91c1c";
      clearTimeout(t._h);
      t._h = setTimeout(()=>{ t.style.display="none"; }, 2600);
    };

    // ---- SAMPLE JSON (matches what your Program Builder sends) ----
    const SAMPLE = JSON.stringify({
      "notes": "I‚Äôm doing a 1k test at the end of the program",
      "gender": "Male",
      "category": "Masters",
      "start_date": "2025-11-26",
      "finish_date": "2025-12-01",
      "athlete_name": "Noel Carey",
      "athlete_email": "noelcarey74@yahoo.ie",
      "weekly_schedule": {
        "Fri": "Water Row",
        "Mon": "Erg (UT2)",
        "Sat": "Weights",
        "Sun": "Erg (UT1/AT)",
        "Thu": "Water Row",
        "Tue": "Weights",
        "Wed": "Rest"
      },
      "intensity_percent": 75
    }, null, 2);

    $("#loadSampleBtn").addEventListener("click", ()=>{
      $("#inputJson").value = SAMPLE;
      toast("Sample JSON loaded");
    });

    $("#clearBtn").addEventListener("click", ()=>{
      $("#inputJson").value = "";
      $("#outputDiary").value = "";
    });

    $("#copyDiaryBtn").addEventListener("click", async ()=>{
      const text = $("#outputDiary").value;
      if (!text.trim()) { toast("Nothing to copy", false); return; }
      try{
        await navigator.clipboard.writeText(text);
        toast("Diary copied ‚úî");
      }catch(e){
        toast("Copy failed", false);
      }
    });

    // ---------- JSON NORMALISATION ----------
    function normalisePayload(raw){
      // Athlete block
      const athlete = raw.athlete ? {...raw.athlete} : {};
      if (!athlete.name && raw.athlete_name) athlete.name = raw.athlete_name;
      if (!athlete.email && raw.athlete_email) athlete.email = raw.athlete_email;
      if (!athlete.gender && raw.gender) athlete.gender = raw.gender;
      if (!athlete.category && raw.category) athlete.category = raw.category;

      // Program block (accept both nested + flat fields)
      const program = raw.program ? {...raw.program} : {};
      if (!program.start_date && raw.start_date) program.start_date = raw.start_date;
      if (!program.end_date && (raw.finish_date || raw.end_date)) {
        program.end_date = raw.finish_date || raw.end_date;
      }
      if (program.intensity_percent == null && raw.intensity_percent != null) {
        program.intensity_percent = raw.intensity_percent;
      }
      if (!program.weekly_schedule && raw.weekly_schedule) {
        program.weekly_schedule = raw.weekly_schedule;
      }
      if (!program.focus && raw.focus) program.focus = raw.focus;
      if (!program.notes && raw.notes) program.notes = raw.notes;

      const title = raw.title ||
        `${athlete.category || "Masters"} ${athlete.gender ? "‚Äì " + athlete.gender : ""} Training Diary`.trim();
      const quote = raw.quote || "Consistency builds champions.";

      return { title, athlete, program, quote };
    }

    function parseISODate(str){
      const [y,m,d] = String(str).split("-").map(x=>parseInt(x,10));
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }

    function formatDateLong(d){
      return d.toLocaleDateString("en-GB", {
        weekday:"long",
        day:"numeric",
        month:"long",
        year:"numeric"
      });
    }

    function formatDateShort(d){
      return d.toISOString().slice(0,10);
    }

    const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    // ---------- DIARY GENERATION ----------
    function buildIntro(meta){
      const { title, athlete, program, quote } = meta;
      const start = program.start_date;
      const end   = program.end_date;
      const cat   = athlete.category || "Masters";
      const gender = athlete.gender || "";
      const intensity = program.intensity_percent ?? 75;
      const focus = program.focus || "Aerobic base and technical consistency";

      const weekly = program.weekly_schedule || {};
      const weeklyLines = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(
        d=>`${d} ${weekly[d] || "Rest"}`
      );

      return [
        `${title}`,
        `Dates: ${start} ‚Üí ${end}`,
        `Category: ${cat}${gender ? " ("+gender+")" : ""}`,
        `Intensity Level: ~${intensity}%`,
        `Primary Focus: ${focus}`,
        ``,
        `Weekly Structure:`,
        ...weeklyLines,
        ``,
        `Quote:`,
        `‚Äú${quote}‚Äù`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateRest(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `None planned.`,
        ``,
        `Main Set:`,
        `Rest day.`,
        ``,
        `Focus:`,
        `Recovery, sleep and general mobility.`,
        ``,
        `Notes:`,
        `Light walking or gentle stretching is encouraged, but no structured training is required.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateWaterRow(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10‚Äì15 minutes light paddling, building gradually from very easy to steady rowing.`,
        `Include 3 √ó 10 stroke builds up to 22‚Äì24 spm with plenty of paddling between.`,
        ``,
        `Main Set:`,
        `Option A ‚Äì continuous:`,
        `‚Ä¢ 40‚Äì50 minutes steady rowing.`,
        ``,
        `Option B ‚Äì broken:`,
        `‚Ä¢ 2 √ó 20‚Äì25 minutes with 3 minutes light paddling between pieces.`,
        `Stroke Rate: 18‚Äì22 spm`,
        `Heart Rate: UT2 to light UT1 (roughly 60‚Äì75% HR max).`,
        ``,
        `Technical Focus:`,
        `‚Ä¢ Clean, quiet catches with the blade fully loaded before the drive.`,
        `‚Ä¢ Strong leg drive while the upper body stays relaxed and supported.`,
        `‚Ä¢ Level hands at the finish and tidy, consistent tap-down.`,
        ``,
        `Focus:`,
        `Boat run, timing and aerobic efficiency with no rush on the slide.`,
        ``,
        `Notes:`,
        `If conditions are poor, shorten the main set slightly but keep it controlled and safe. Prioritise timing and balance over power.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateWeights(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `5‚Äì8 minutes light cardio (row, cycle or treadmill) plus dynamic mobility for hips, hamstrings, shoulders and back.`,
        ``,
        `Main Set:`,
        `Block A`,
        `‚Ä¢ Goblet Squat ‚Äì 3 √ó 10`,
        `‚Ä¢ Romanian Deadlift ‚Äì 3 √ó 8`,
        ``,
        `Block B`,
        `‚Ä¢ Lat Pulldown or Assisted Pull-down ‚Äì 3 √ó 10`,
        `‚Ä¢ Dumbbell Bench Press ‚Äì 3 √ó 8`,
        ``,
        `Block C`,
        `‚Ä¢ Seated or Cable Row ‚Äì 3 √ó 10`,
        `‚Ä¢ Front Plank ‚Äì 3 √ó 30‚Äì40 seconds`,
        ``,
        `Rest:`,
        `60‚Äì90 seconds between working sets.`,
        ``,
        `Technical Focus:`,
        `‚Ä¢ Neutral spine at all times (no rounding).`,
        `‚Ä¢ Drive from the legs and hips rather than the lower back.`,
        `‚Ä¢ Smooth, controlled lowering phase; strong but not jerky on the way up.`,
        ``,
        `Focus:`,
        `Maintain rowing-specific strength and robustness without creating heavy fatigue.`,
        ``,
        `Notes:`,
        `Choose loads that feel ‚Äúcomfortably hard‚Äù on the last 2 reps but always leave 1‚Äì2 good reps in reserve.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateErgUT2(label){
      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes very easy rowing, gradually building from light paddling to a steady UT2 rhythm.`,
        ``,
        `Main Set:`,
        `2 √ó 40 minutes continuous UT2 rowing.`,
        `Stroke Rate: 18‚Äì20 spm`,
        `Heart Rate: 60‚Äì70% HR max (easy conversational effort).`,
        `Rest: 3 minutes very light paddling between pieces.`,
        ``,
        `Technical Focus:`,
        `‚Ä¢ Long, relaxed stroke with quiet shoulders.`,
        `‚Ä¢ Strong connection through the legs before the body and arms.`,
        `‚Ä¢ Smooth, unhurried recovery with balanced posture on the slide.`,
        ``,
        `Focus:`,
        `Aerobic conditioning and rhythm at approximately 75% effort, without chasing split.`,
        ``,
        `Notes:`,
        `You should always feel that you could continue another 10‚Äì15 minutes at the end of each piece.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function templateErgUT1AT(label, hasTest){
      const mainLines = hasTest ? [
        `Main Set:`,
        `1) Warm-up build:`,
        `‚Ä¢ 10 minutes UT2 at 18‚Äì20 spm.`,
        `‚Ä¢ 3 √ó 30 seconds at 1k pace with 90 seconds light paddling between.`,
        ``,
        `2) 1k Test Piece:`,
        `‚Ä¢ 1,000 m at best sustainable race effort.`,
        `Stroke Rate: 30‚Äì34 spm.`,
        `Pacing: aim for a strong but controlled first 500 m, then push in the final 300‚Äì200 m.`,
        ``,
        `3) Cool-down:`,
        `‚Ä¢ 10‚Äì15 minutes light UT2 paddling at 18‚Äì20 spm.`,
      ] : [
        `Main Set:`,
        `3 √ó 8‚Äì10 minutes at UT1 / AT (comfortably hard).`,
        `Stroke Rate: 22‚Äì26 spm.`,
        `Rest: 3‚Äì4 minutes very light paddling between pieces.`
      ];

      return [
        `${label}`,
        ``,
        `Warm-up:`,
        `10 minutes light rowing, gradually building from UT2 into the lower end of UT1 (20‚Äì22 spm).`,
        ``,
        ...mainLines,
        ``,
        `Technical Focus:`,
        `‚Ä¢ Powerful but relaxed leg drive; stay tall through the trunk.`,
        `‚Ä¢ Keep the handle speed smooth into and away from the body.`,
        `‚Ä¢ No rushing on the slide, even when the rate is high.`,
        ``,
        `Focus:`,
        hasTest
          ? `Use this as a performance marker. Stay composed in the first half of the 1k and finish with intent.`
          : `Build threshold fitness while keeping the stroke long and tidy.`,
        ``,
        `Notes:`,
        hasTest
          ? `Record split, rate and heart rate at the end of the test. Use the cool-down to let HR and breathing fully settle.`
          : `You should feel challenged but in control. You should not be completely empty at the end.`,
        ``,
        `Athlete Notes:`,
        `_________________________________________________`,
        ``,
        `------------------------------------------------------------`,
        ``
      ].join("\n");
    }

    function buildDiary(meta){
      const { program } = meta;
      const start = parseISODate(program.start_date);
      const end   = parseISODate(program.end_date);

      if (!start || !end) {
        throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
      }
      if (end < start){
        throw new Error("end_date / finish_date is before start_date.");
      }

      const weekly = program.weekly_schedule || {};
      const hasTestNote = String(program.notes || "").toLowerCase().includes("1k");

      let out = buildIntro(meta);

      const cur = new Date(start.getTime());
      while (cur <= end){
        const dow = DOW[cur.getDay()];  // "Mon", "Tue", ...
        const session = weekly[dow] || "Rest";
        const label = `üóìÔ∏è ${formatDateLong(cur)} ‚Äî ${session}`;

        if (/erg\s*\(ut2\)/i.test(session)){
          out += templateErgUT2(label);
        } else if (/erg\s*\(ut1\/?at\)/i.test(session)){
          // If note says 1k test and this is the *last day* of the block, treat as test.
          const isLastDay = formatDateShort(cur) === formatDateShort(end);
          out += templateErgUT1AT(label, hasTestNote && isLastDay);
        } else if (/water row/i.test(session)){
          out += templateWaterRow(label);
        } else if (/weight/i.test(session)){
          out += templateWeights(label);
        } else {
          out += templateRest(label);
        }

        cur.setDate(cur.getDate() + 1);
      }

      return out.trim() + "\n";
    }

    // ---------- MAIN BUTTON HANDLER ----------
    $("#generateBtn").addEventListener("click", ()=>{
      const src = $("#inputJson").value.trim();
      if (!src){
        toast("Paste JSON first", false);
        return;
      }
      let raw;
      try{
        raw = JSON.parse(src);
      }catch(e){
        toast("Invalid JSON: " + e.message, false);
        return;
      }

      try{
        const meta = normalisePayload(raw);
        if (!meta.program.start_date || !meta.program.end_date){
          throw new Error("start_date and finish_date (or program.start_date/program.end_date) are required.");
        }
        const diary = buildDiary(meta);
        $("#outputDiary").value = diary;
        toast("Diary generated ‚úî");
      }catch(e){
        toast(e.message || "Error generating diary", false);
      }
    });
  </script>
</body>
</html>
